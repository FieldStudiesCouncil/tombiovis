if(function(e){"use strict";if(window.caches||(window.caches=null),"undefined"!=typeof tombiover&&(e.opts.tombiover=tombiover),"undefined"!=typeof tombiopath&&(e.opts.tombiopath=tombiopath),"undefined"!=typeof tombiokbpath&&(e.opts.tombiokbpath=tombiokbpath),!e.opts.pwaSupress&&"serviceWorker"in navigator){var s="sw.js?tombiokbpath="+encodeURIComponent(e.opts.tombiokbpath)+"&tombiopath="+encodeURIComponent(e.opts.tombiopath);e.opts.pwa=!0,navigator.serviceWorker.register(s).then(function(){i("Service worker started successfully")}).catch(function(){i("Service worker failed")})}else i("Service worker not called");function i(s){console.log(s),window.console||(window.console={log:function(){}}),e.opts||(e.opts={}),e.opts.toolconfig||(e.opts.toolconfig={});var i=new URLSearchParams(window.location.search).get("gui");i&&(e.opts.gui=i),e.f={},e.d={},e.d.nbnMapCache={},e.d.scoreColours=["#fc8d59","#ffffbf","#91bfdb"],e.v={},e.v.visualisations={},e.js={},e.gui={},e.gui.sharedKeyInput={},e.d.softwareMetadata={title:"FSC Identikit",year:"2018",authors:"Burkmar, R.",publisher:"Field Studies Council",location:"Shrewsbury, England",contact:"rburkmar@ceh.ac.uk",version:"1.9.0"};var o=["vis1","vis2","vis5","vis4","vis3"];e.v.includedVisualisations=[];var t=e.js.jsFiles={add:function(s,i,o,t){e.js.jsFiles[s]=Object.create(n),e.js.jsFiles[s].init(s,i,o,t)},asArray:function(){var s=[];for(var i in e.js.jsFiles)e.js.jsFiles.hasOwnProperty(i)&&s.push(e.js.jsFiles[i]);return s}},n={init:function(s,i,o,t){this.id=s,this.file=r(e.opts.tombiopath+i),this.tombiover=o,this.requires=[],this.requiresFirst=[],this.css=[],this.toolName=t},addCSS:function(s){this.css.push(r(e.opts.tombiopath+s))},loadJs:function(e,s){if(!this.p){var i=this.id,o=[];this.requires.forEach(function(e){o.push(t[e].loadJs(i,!1))});var n=[];this.requiresFirst.forEach(function(e){n.push(t[e].loadJs(i,!0))});var r=this.file,d=this.css,c=this.initF;this.p=Promise.all(n).then(function(){var t=new Promise(function(o,t){var n=document.createElement("script");n.src=r,n.onreadystatechange=n.onload=function(){if(!n.readyState||/loaded|complete/.test(n.readyState)){var u="";e&&(u=s?" (req before "+e+")":" (req by "+e+")"),console.log("%cLoaded JS file "+a(r)+" "+u,"color: blue"),c&&c(),d.forEach(function(e){var s=document.createElement("link");s.rel="stylesheet",s.type="text/css",s.href=e,document.querySelector("head").appendChild(s),console.log("%cCSS link added for "+a(e),"color: green")}),o()}else console.log("%cFailed to load JS file for "+i,"color: red"),t()},document.querySelector("head").appendChild(n)});return o.push(t),Promise.all(o)})}return this.p}};function r(s){if(e.opts.devel)return s;if(s.indexOf("dependencies")>-1)return s;var i=s.lastIndexOf("."),o=s.substr(i+1),t=s.substr(0,i),n=t.lastIndexOf("/"),r=-1==n?t:t.substr(n+1);return e.opts.tombiopath+"min/"+o+"/"+r+".min."+o}function a(e){var s=e.split("/");return s[s.length-1]}function d(s,i){e.opts.toolconfig[s]||(e.opts.toolconfig[s]={}),t[s].requiresFirst||(t[s].requiresFirst=[]),i&&(e.opts.toolconfig[s].keyinput||(e.opts.toolconfig.genKeyinput&&e.opts.toolconfig.genKeyinput.default?e.opts.toolconfig[s].keyinput=e.opts.toolconfig.genKeyinput.default:e.opts.toolconfig[s].keyinput="keyInput"),t[s].requiresFirst.push(e.opts.toolconfig[s].keyinput),console.log("Requires first",s,t[s].requiresFirst))}e.f.showDownloadSpinner=function(){var e=document.createElement("div");e.id="downloadspin";e.innerHTML='<div class="loader"><svg viewBox="0 0 32 32" width="32" height="32"><circle id="spinner" cx="16" cy="16" r="14" fill="none"></circle></svg></div>';var s=document.getElementById("tombiod3");s.insertBefore(e,s.firstChild)},e.f.hideDownloadSpinner=function(){var e=document.getElementById("tombiod3"),s=document.getElementById("downloadspin");e.removeChild(s)},t.add("jquery","dependencies/jquery-3.1.1/jquery-3.1.1.min.js"),t.add("d3","dependencies/d3-5.7.0/d3.min.js"),t.add("jqueryui","dependencies/jquery-ui-1.12.1/jquery-ui.min.js"),t.jqueryui.addCSS("dependencies/jquery-ui-1.12.1/jquery-ui.min.css"),t.jqueryui.addCSS("dependencies/jquery-ui-1.12.1/jquery-ui.theme.min.css"),t.jqueryui.addCSS("css/jquery-ui-tombio.css"),t.add("zoomMaster","dependencies/zoom-master/jquery.zoom.min.js"),t.add("galleria","dependencies/galleria-1.5.7/galleria/galleria-1.5.7.min.js"),t.galleria.addCSS("dependencies/galleria-1.5.7/galleria/themes/classic/galleria.classic.css"),t.galleria.initF=function(){Galleria.loadTheme(e.opts.tombiopath+"dependencies/galleria-1.5.7/galleria/themes/classic/galleria.classic.min.js"),Galleria.on("image",function(e){$(e.imageTarget).parent().zoom({on:"grab"})})},t.add("mousewheel","dependencies/jquery.mousewheel.min.js"),t.add("hammer","dependencies/hammer.min.js"),t.add("pqselect","dependencies/pqselect-1.3.2/pqselect.min.js"),t.pqselect.addCSS("dependencies/pqselect-1.3.2/pqselect.min.css"),t.pqselect.requiresFirst=["jqueryui"],t.add("pqgrid","dependencies/pqgrid-2.1.0/pqgrid.min.js"),t.pqgrid.addCSS("dependencies/pqgrid-2.1.0/pqgrid.min.css"),t.pqgrid.requiresFirst=["jqueryui"],t.add("keyinputTemplate","keyinputTemplate.js",!0),t.add("keyInput","keyinput.js",!0),t.keyInput.addCSS("css/keyinput.css"),t.keyInput.requires=["pqselect","jqueryui"],t.add("keyInputBasic","keyinputBasic.js",!0),t.keyInputBasic.addCSS("css/keyinputbasic.css"),t.add("keyInputOnsenUi","keyinputOnsenUi.js",!0),t.keyInputOnsenUi.addCSS("css/keyinputOnsenUi.css"),t.keyInputOnsenUi.requiresFirst=["onsenui"],t.add("tombiovis","tombiovis.js",!0),t.tombiovis.addCSS("css/tombiovis.css"),t.tombiovis.requires=["kbchecks"],t.add("kbchecks","kbchecks.js",!0),t.add("score","score.js",!0),t.add("taxonselect","taxonselect.js",!0),t.taxonselect.addCSS("css/taxonselect.css"),t.taxonselect.requires=["jqueryui"],t.add("visP","visP.js",!0),t.visP.requires=["galleria","zoomMaster"],t.add("guiTemplate","guiTemplate.js",!0),t.add("guiLargeJqueryUi","guiLargeJqueryUi.js",!0),t.guiLargeJqueryUi.addCSS("css/guiLargeJqueryUi.css"),t.guiLargeJqueryUi.requires=["jqueryui"],t.add("guiLarge","guiLarge.js",!0),t.guiLarge.addCSS("css/guiLarge.css"),t.add("guiOnsenUi","guiOnsenUi.js",!0),t.guiOnsenUi.addCSS("css/guiOnsenUi.css"),t.guiOnsenUi.requiresFirst=["onsenui"],t.add("onsenui","dependencies/onsenui-2.10.10/js/onsenui.min.js"),t.onsenui.addCSS("dependencies/onsenui-2.10.10/css/onsenui.min.css"),t.onsenui.addCSS("dependencies/onsenui-2.10.10/css/onsen-css-components.min.css"),t.onsenui.addCSS("dependencies/onsenui-2.10.10/css/onsenui-fonts.css"),t.add("visTemplate","visTemplate/visTemplate.js"),t.visTemplate.requiresFirst=["visP"],t.add("vis1","vis1/vis1.js",!0,"Two-column key"),t.vis1.addCSS("vis1/vis1.css"),t.vis1.requiresFirst=["visP"],t.vis1.requires=["score"],d("vis1",!0),t.add("vis2","vis2/vis2.js",!0,"Single-column key"),t.vis2.addCSS("vis2/vis2.css"),t.vis2.requiresFirst=["visP"],t.vis2.requires=["score"],d("vis2",!0),t.add("vis3","vis3/vis3.js",!0,"Side by side comparison"),t.vis3.addCSS("vis3/vis3.css"),t.vis3.requiresFirst=["visP"],t.vis3.requires=["taxonselect","pqgrid","score"],d("vis3",!1),t.add("vis4","vis4/vis4.js",!0,"Full taxon details"),t.vis4.addCSS("vis4/vis4.css"),t.vis4.requiresFirst=["visP"],t.vis4.requires=["taxonselect"],d("vis4",!1),t.add("vis5","vis5/vis5.js",!0,"Circle-pack key"),t.vis5.addCSS("vis5/vis5.css"),t.vis5.requiresFirst=["visP"],t.vis5.requires=["score"],d("vis5",!0),t.add("vis6","vis6/vis6.js",!0,"Mobile key"),t.vis6.addCSS("vis6/vis6.css"),t.vis6.requiresFirst=["visP"],t.vis6.requires=["score"],d("vis6",!0),t.add("visEarthworm2","visEarthworm2/visEarthworm2.js",!0,"Bespoke earthworm key"),t.visEarthworm2.addCSS("visEarthworm2/visEarthworm2.css"),t.visEarthworm2.requiresFirst=["visP"],t.visEarthworm2.requires=["jqueryui","score"],e.f.startLoad=function(){e.f.showDownloadSpinner(),Promise.all([t.d3.loadJs(),t.jquery.loadJs()]).then(function(){return jQuery(document).ready(function(){jQuery("#tombiod3").append(jQuery('<div id="tombiod3vis">'))}),function(){var s,i=new Date,t=[];s=d3.csv(e.opts.tombiokbpath+"taxa.csv?t=kbcsv",function(e){var s=r(e);if(s)var i=Object.keys(s).reduce((e,i)=>(e[i.toLowerCase()]=s[i],e),{});else var i=null;return i}).then(function(s){e.d.taxa=s,console.log("%cLoading - kb taxa loaded","color: blue")}).catch(function(){console.log("%cError loading taxa.csv","color: red")}),t.push(s),s=d3.csv(e.opts.tombiokbpath+"characters.csv?t=kbcsv",function(e){var s=r(e);return s&&(s.Character&&(s.Character=s.Character.toLowerCase()),s.Status&&(s.Status=s.Status.toLowerCase()),s.ValueType&&(s.ValueType=s.ValueType.toLowerCase()),s.ControlType&&(s.ControlType=s.ControlType.toLowerCase())),s}).then(function(s){e.d.characters=s,console.log("%cLoading - kb characters loaded","color: blue")}).catch(function(){e.d.characters=[]}),t.push(s),s=d3.csv(e.opts.tombiokbpath+"values.csv?t=kbcsv",function(e){var s=r(e);return s&&s.Character&&(s.Character=s.Character.toLowerCase()),s}).then(function(s){e.d.values=s,console.log("%cLoading - kb values loaded","color: blue")}).catch(function(){e.d.values=[]}),t.push(s),s=d3.csv(e.opts.tombiokbpath+"media.csv?t=kbcsv",function(e){var s=r(e);return s&&(s.Character&&(s.Character=s.Character.toLowerCase()),s.Type&&(s.Type=s.Type.toLowerCase()),s.UseFor&&(s.UseFor=s.UseFor.toLowerCase()),s.TipStyle&&(s.TipStyle=s.TipStyle.toLowerCase())),s}).then(function(s){e.d.media=s,console.log("%cLoading - kb media loaded","color: blue")}).catch(function(){e.d.media=[]}),t.push(s),e.d.kbconfig={},e.d.kbmetadata={},e.d.kbreleaseHistory=[];var n=[];return s=d3.csv(e.opts.tombiokbpath+"config.csv?t=kbcsv",function(e){var s=r(e);return s&&(s.Key&&(s.Key=s.Key.toLowerCase()),s.Type&&(s.Type=s.Type.toLowerCase()),s.Mandatory&&(s.Mandatory=s.Mandatory.toLowerCase())),s}).then(function(s){e.d.config=s,s.forEach(function(s){"config"==s.Type&&(e.d.kbconfig[s.Key]=s.Value),e.opts.selectedTool,"excludedDefaultTools"==s.Key&&""!=s.Value.trim()&&s.Value.split(",").forEach(function(e){n.push(e.trim())}),"otherIncludedTools"==s.Key&&""!=s.Value.trim()&&s.Value.split(",").forEach(function(s){e.v.includedVisualisations.push(s.trim())}),"metadata"==s.Type&&(e.d.kbmetadata[s.Key]=s.Value),"release"==s.Key&&e.d.kbreleaseHistory.push(s)}),console.log("%cLoading - kb config loaded","color: blue")}).catch(function(){e.d.config=[]}).finally(function(){o.forEach(function(s){-1==n.indexOf(s)&&e.v.includedVisualisations.push(s)}),e.opts.tools&&Array.isArray(e.opts.tools)&&e.opts.tools.length>0&&(e.v.includedVisualisations=e.opts.tools)}),t.push(s),Promise.all(t).then(function(){var e,s;console.log("%cKB loaded in "+(e=i,s=new Date-e,s/=1e3,Math.round(100*s)/100),"color: blue")});function r(e){if("#"!=e[Object.keys(e)[0]].substr(0,1)){var s=!0;for(var i in e)e.hasOwnProperty(i)&&(e[i]=e[i]?e[i].trim():"","#"==e[i].substr(0,1)&&(e[i]=""),"?"==e[i]&&(e[i]=""),""!=e[i]&&(s=!1));return s?null:e}return null}}()}).then(function(){return e.templates={gui:{main:{}}},e.opts.devel?Promise.all([t.guiTemplate.loadJs(),t.visTemplate.loadJs(),t.keyinputTemplate.loadJs()]):Promise.resolve()}).then(function(){return Promise.all([t.tombiovis.loadJs()])}).then(function(){if(e.opts.gui)var s=e.opts.gui;else s="guiLargeJqueryUi";var i=[t[s].loadJs()];Promise.all(i).then(function(){e.f.hideDownloadSpinner(),e.f.loadcomplete()})})},e.opts.loadWait||e.f.startLoad()}}(this.tombiovis?this.tombiovis:this.tombiovis={}),tombiovis.opts.devel)var v=tombiovis;