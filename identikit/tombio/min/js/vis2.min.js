!function(t,e){"use strict";var i,a="vis2",n=e.v.visualisations[a]=Object.create(e.v.visP);n.visName=a,n.initialise=function(){i=this,this.metadata.title="Single-column key",this.metadata.year="2018",this.metadata.authors="Burkmar, R",this.metadata.publisher="Field Studies Council",this.metadata.location="Shrewsbury, England",this.metadata.contact="r.burkmar@field-studies-council.org",this.metadata.version="1.8.0",this.helpFiles=[e.opts.tombiopath+"vis2/vis2Help.html",e.opts.tombiopath+"common/taxonDetailsHelp.html",e.opts.tombiopath+"common/full-details.html",e.opts.tombiopath+"common/stateInputHelp.html"],this.showWeightedScores=!0,this.displayToolTips=!0,d3.select("#"+this.visName).append("svg").attr("id","vis2Svg");var r=e.opts.toolconfig[this.visName].keyinput;e.gui.sharedKeyInput[r]||(e.gui.sharedKeyInput[r]=Object.create(e.gui[r]),e.gui.sharedKeyInput[r].init(t(e.gui.main.divInput))),n.inputControl=e.gui.sharedKeyInput[r],this.initialised=!0,e.f.checkInterface(a,e.templates.visTemplate,e.v.visualisations[a])},n.refresh=function(){i=this;var t=d3.scaleLinear().domain([-1,0,1]).range(e.d.scoreColours),n=d3.max(e.d.taxa,function(t){return t.visState.score.overall}),r=d3.min(e.d.taxa,function(t){return t.visState.score.overall}),s=d3.scaleLinear().domain([r,0,n]).range(e.d.scoreColours),o=[];e.d.taxa.forEach(function(t){o.push(t)}),e.f.sortTaxa(o);var c=0;o.forEach(function(t){d3.select("#vis2Svg").append("text").attr("class","scientificnames tmpTaxonText").style("opacity",0).text(t.taxon)}),d3.selectAll(".tmpTaxonText").each(function(t){var e=this.getBBox();e.width>c&&(c=e.width)}),c+=56;var l=0,u=[];e.d.characters.forEach(function(t){t.stateSet&&u.push(t)}),u.forEach(function(t){d3.select("#vis2Svg").append("text").attr("class","type2VisCharacter tmpCharacterText").style("opacity",0).text(t.Label)}),d3.selectAll(".tmpCharacterText").each(function(){var t=this.getBBox();t.width>l&&(l=t.width)}),d3.selectAll(".tmpCharacterText").remove();var h=d3.select("#vis2Svg").selectAll(".type2VisTaxon").data(o,function(t,e){return t.taxon}),d=h.enter(),p=h.exit(),m=d.append("g").attr("class","type2VisTaxon").style("opacity",0).each(function(t,i){d3.select(this).append("rect").attr("class","taxarect"),d3.select(this).append("text").attr("class","scientificnames").text(function(){return t.taxon}).style("cursor","pointer").on("click",function(){e.gui.main.showFullDetails(t.taxon,0)}),d3.select(this).append("rect").attr("class","type2VisOverallInd").attr("width",30).attr("height",26).attr("x",2).attr("title","Overall weighted score"),d3.select(this).append("text").attr("class","type2VisOverallIndText").attr("text-anchor","middle").attr("alignment-baseline","central").attr("x",15).attr("opacity",0).attr("text",0).attr("cursor","default").attr("title","Overall weighted score"),d3.select(this).append("svg:image").attr("xlink:href",e.opts.tombiopath+"resources/camera.png").attr("class","taxonImageLink").attr("width",16).attr("height",16).attr("x",function(){return 36}).style("display",function(){return e.d.media.filter(function(e){if(e.Taxon==t.taxon.kbValue)return!0}).length>0?null:"none"}).on("click",function(){e.gui.main.showFullDetails(t.taxon,1)})}).merge(h);m.transition().duration(1e3).style("opacity",1).each(function(t,e){d3.select(this).select(".taxarect").transition().duration(1e3).attr("x",function(){return 0}).attr("y",function(){return l+34*e+2}).attr("width",function(){return c+2+34*u.length}).attr("height",function(){return 30}),d3.select(this).select(".scientificnames").transition().duration(1e3).attr("x",function(){var t=this.getBBox();return c-t.width}).attr("y",function(){var t=this.getBBox();return l+34*e+t.height+(34-t.height)/3}),d3.select(this).select(".type2VisOverallInd").transition().duration(1e3).attr("y",function(){return l+4+34*e}).attr("fill",function(){return s(t.visState.score.overall)}),d3.select(this).select(".type2VisOverallIndText").transition().duration(1e3).attr("y",function(){return l+34*(e+.5)}).attr("text",function(){var e=100*t.visState.score.overall;e=Math.round(e)/100,d3.select(this).text(e)}).attr("opacity",1),d3.select(this).select(".taxonImageLink").transition().duration(1e3).attr("y",function(){return l+34*e+2+7})}),p.transition().duration(1e3).style("opacity",0).remove(),e.gui.main.createTaxonToolTips(".scientificnames",this.displayToolTips),e.gui.main.tooltip(".type2VisOverallInd"),e.gui.main.tooltip(".type2VisOverallIndText"),m.each(function(a,n){var r=n,s=a,o=e.f.taxonTag(a.taxon.kbValue),h=d3.select(this).selectAll(".type2VisIndicators-"+o).data(u,function(t,e){return t.Character+"-"+o});h.enter().append("g").attr("class","type2VisIndicators-"+o).style("cursor","pointer").on("click",function(t,i){e.gui.main.dialog("Character score details",e.f.getCharacterScoreDetails(s,t))}).each(function(){d3.select(this).append("circle").attr("r",13).attr("class","type2VisInd").attr("fill","white").style("opacity",0),d3.select(this).append("text").style("opacity",0).attr("class","type2VisIndtext").attr("text-anchor","middle").attr("alignment-baseline","central")}).merge(h).each(function(a,n){d3.select(this).select(".type2VisInd").transition().duration(1e3).attr("cx",function(){return c+2+34*(n+.5)}).attr("cy",function(){return l+34*(r+.5)}).attr("fill",function(){return t(s[a.Character].score.overall)}).style("opacity",1),d3.select(this).select(".type2VisIndtext").transition().duration(1e3).attr("text",function(){if(i.showWeightedScores)var t=Number(e.d.oCharacters[a.Character].Weight)/10;else t=1;var n=s[a.Character].score.overall*t*10;n=Math.floor(n)/10,d3.select(this).text(n)}).attr("x",function(){return c+2+34*(n+.5)}).attr("y",function(){return l+34*(r+.5)}).style("opacity",1)}),h.exit().transition().duration(1e3).style("opacity",0).remove()});var g=d3.select("#vis2Svg").selectAll(".type2VisCharacter").data(u,function(t,e){return t.Character});g.enter().append("text").attr("class","type2VisCharacter").style("opacity",0).text(function(t){return t.Label}).merge(g).transition().duration(1e3).style("opacity",1).attr("x",function(t,e){return c+2+34*(e+.5)}).attr("y",function(){var t=this.getBBox();return l-t.width}).attr("transform",function(t,e){var i=this.getBBox();return"rotate(90 "+(c+2+34*(e+.5))+","+(l-i.width)+")"}),g.exit().transition().duration(1e3).attr("x",0).attr("y",0).style("opacity",0).remove(),d3.select("#vis2Svg").transition().duration(1e3).attr("width",function(t,e){return c+2+34*u.length}).attr("height",function(t,i){return l+34*e.d.taxa.length}),e.gui.main.contextMenu.addItem("Get URL for single-column key",function(){var t;(t=[]).push("selectedTool="+a),Array.prototype.push.apply(t,e.f.setParamsFromControls()),t.push("weighted="+i.showWeightedScores),t.push("imgtips="+i.displayToolTips),e.f.createViewURL(t)},!1,[this.visName]),this.showWeightedScores?(e.gui.main.contextMenu.removeItem("Show weighted scores"),e.gui.main.contextMenu.addItem("Show unweighted scores",function(){i.showWeightedScores=!1,i.refresh()},!1,[this.visName])):(e.gui.main.contextMenu.removeItem("Show unweighted scores"),e.gui.main.contextMenu.addItem("Show weighted scores",function(){i.showWeightedScores=!0,i.refresh()},!1,[this.visName])),this.displayToolTips?(e.gui.main.contextMenu.addItem("Remove taxon image tooltips",function(){i.displayToolTips=!1,e.gui.main.contextMenu.removeItem("Remove taxon image tooltips"),i.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),e.gui.main.contextMenu.removeItem("Display taxon image tooltips")):(e.gui.main.contextMenu.addItem("Display taxon image tooltips",function(){i.displayToolTips=!0,e.gui.main.contextMenu.removeItem("Display taxon image tooltips"),i.refresh()},!0,[this.visName],["guiLargeJqueryUi"]),e.gui.main.contextMenu.removeItem("Remove taxon image tooltips"))},n.urlParams=function(t){t.weighted&&(i.showWeightedScores="true"===t.weighted),t.imgtips&&(i.displayToolTips="true"===t.imgtips),e.f.initControlsFromParams(t)},n.show=function(){t("#vis2").show(),t(n.inputControl.divSel).show(),n.inputControl.initFromCharacterState()},n.hide=function(){t("#vis2").hide(),t(n.inputControl.divSel).hide()}}(jQuery,this.tombiovis);