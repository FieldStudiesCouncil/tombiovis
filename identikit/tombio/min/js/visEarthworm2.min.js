!function(t,e){"use strict";var a,o="visEarthworm2",r=e.v.visualisations[o]=Object.create(e.v.visP);function i(t,e){return t.sort(function(t,a){var o=t.visState.visEarthworm2.segdiffTotal,r=a.visState.visEarthworm2.segdiffTotal;return r>o?-1:o>r?1:r==o?t.visState.visEarthworm2[e]>a.visState.visEarthworm2[e]?1:-1:void 0})}function s(t,e){var o=d3.select(this);d3.select(this.parentNode).select("text").style("opacity","1").attr("x",Number(o.attr("cx"))).attr("y",Number(o.attr("cy"))+4),o.attr("oR",o.attr("r")),o.attr("r",function(){var r=a.scoreChars[e];return null!=t.visState.visEarthworm2.scores[r.Character]&&"segnum"==r.EsbScoreType?Number(o.attr("r"))+a.taxspace:Number(Number(o.attr("r")))}).attr("cursor",function(){var o=a.scoreChars[e];return null!=t.visState.visEarthworm2.scores[o.Character]&&"segnum"==o.EsbScoreType?"none":"auto"})}function n(t,e){var a=d3.select(this),o=d3.select(this.parentNode).select("text");a.attr("r",Number(a.attr("oR"))),o.style("opacity","0")}r.visName=o,r.initialise=function(){a=this,this.metadata.title="Bespoke earthworm key",this.metadata.authors="Rich Burkmar",this.metadata.year="2018",this.metadata.publisher="Field Studies Council",this.metadata.location="Preston Montford",this.metadata.contact="richardb@field-studies-council.org",this.metadata.version="4.0",this.taxwidth=205,this.taxheight=32,this.taxspace=5,this.taxexpanded=null,this.delay=200,this.indrad=6,this.imagedim=12,this.inputControl=Object.create(e.gui.keyInputEarthworm),this.inputControl.init(t(e.gui.main.divInput)),this.helpFiles=[e.opts.tombiopath+"visEarthworm2/visEarthwormHelp2.html"];var r,i=t("<div>").appendTo(t("#"+this.visName));t("<div>").attr("id","tombioEsbHeaderTaxa").appendTo(i).html('<span id="tombioEsbCandidateTaxa">Possible species  <span class="tombioEsbConfidenceLevel" id="tombioEsbConfidenceLevelButton">!</span></span><span id="tombioEsbExcludedTaxa">Unlikely species</span>'),d3.select("#"+this.visName).append("svg").attr("id","tombioEsbMultiaccess"),t("#tombioEsbHeaderTaxa").css("width",3*this.taxspace+2*this.taxwidth),t("#tombioEsbCandidateTaxa").css("left",1*this.taxspace),t("#tombioEsbExcludedTaxa").css("left",2*this.taxspace+this.taxwidth),t.get(e.opts.tombiopath+"/visEarthworm2/confidence.html",function(o){t("<div>").appendTo(t("#"+a.visName)).html(o.replace(/##tombiopath##/g,e.opts.tombiopath)),t("#tombioEsbConfidenceLevelButton").click(function(e){var o=a.scoreChars.filter(function(t){return t.stateSet}).length;t("#tombioEsbCharCount").html(a.scoreChars.length),t("#tombioEsbCharUsed").html(o),t("#tombioEsbConfidenceDialog").dialog("open")}),t("#tombioEsbConfidenceDialog").dialog({title:"Identification confidence",autoOpen:!1,modal:!0,width:410,height:450,show:{effect:"slideDown",duration:500},hide:{effect:"explode",duration:500}})}),t("<div>").attr("id","tombioEsbPopup").appendTo(t("#"+a.visName)),t("<div>").attr("id","tombioEsbPopupTabs").appendTo(t("#tombioEsbPopup"));var s=t("<ul>").appendTo(t("#tombioEsbPopupTabs")),n=t("<li>").appendTo(s);t("<a>").attr("href","#tombioEsbPopupTabs1").text("Map").appendTo(n);var l=t("<li>").appendTo(s);t("<a>").attr("href","#tombioEsbPopupTabs2").text("Information").appendTo(l),t("<div>").attr("id","tombioEsbPopupTabs1").appendTo(t("#tombioEsbPopupTabs")),t("<div>").attr("id","tombioEsbMapDiv").appendTo(t("#tombioEsbPopupTabs1")),t("<img>").attr("id","tombioEsbNbnLogo").appendTo(t("#tombioEsbPopupTabs1")),t("<div>").attr("id","tombioEsbNbnLoading").text("Loading distribution map from NBN...").appendTo(t("#tombioEsbPopupTabs1")),t("<div>").attr("id","tombioEsbPopupTabs2").appendTo(t("#tombioEsbPopupTabs")),t("<div>").attr("id","tombioEsbSpInfo").appendTo(t("#tombioEsbPopupTabs2")),r=t("<a>").attr("target","_blank").attr("href","http://www.field-studies-council.org/publications/pubs/earthworms.aspx").appendTo(t("#tombioEsbPopupTabs2")),t("<img>").attr("src",e.opts.tombiopath+"/visEarthworm2/resources/sherlock.png").css("float","left").css("width","120px").css("padding","0 10px 10px 0").appendTo(r),t("<p>").html('More information on the morphology and ecology of <i><span id="tombioEsbInfoSpName"></span></i>can be found in Emma Sherlock\'s FSC AIDGAP publication,<a href="http://www.field-studies-council.org/publications/pubs/earthworms.aspx" target="_blank"> <span class="tombioEsbBooklink">Key to the earthworms of UK and Ireland</span></a>, on <b>pages <span id="tombioEsbInfoSpAccount"></span> (species account) and <span id="tombioEsbInfoSpTable"></span> (species comparison chart)</b>.(The knowledge base behind this visualisation is drawn from Emma Sherlock\'s key.)').appendTo(t("#tombioEsbPopupTabs2")),t("<p>").html('Additional information can be found in the Linnean Society synopsis,<a href="http://www.field-studies-council.org/publications/pubs/earthworms-synopsis.aspx" target="_blank"> <span class="tombioEsbBooklink">Earthworms</span></a>, by Sims and Gerard, also published by FSC.').appendTo(t("#tombioEsbPopupTabs2")),t("#tombioEsbPopup").dialog({autoOpen:!1,width:410,height:610,show:{effect:"slideDown",duration:500},hide:{effect:"explode",duration:500}}),t("#tombioEsbPopup").parent().find(".ui-dialog-title").css("font-style","italic"),t("#tombioEsbPopupTabs").tabs(),this.scoreChars=[],e.d.characters.filter(function(t){return t.EsbKeyOrder}).sort(function(t,e){return t.EsbKeyOrder-e.EsbKeyOrder}).forEach(function(t){a.scoreChars.push(t)}),this.displayChars=[],e.d.characters.filter(function(t){return t.EsbKeyOrder||t.EsbColourParams}).sort(function(t,e){return t.EsbKeyOrder&&e.EsbKeyOrder?t.EsbKeyOrder-e.EsbKeyOrder:t.EsbKeyOrder&&!e.EsbKeyOrder?-1:!t.EsbKeyOrder&&e.EsbKeyOrder?1:t.EsbColourParams.split(" ")[0]-e.EsbColourParams.split(" ")[0]}).forEach(function(t){a.displayChars.push(t)}),this.taxexpanded=2*(this.displayChars.length+1)*(this.indrad+this.taxspace),e.d.taxa.forEach(function(t){t.visState.visEarthworm2.scores={},a.scoreChars.forEach(function(e){t.visState.visEarthworm2.scores[e.Character]=null}),t.visState.visEarthworm2.x=0,t.visState.visEarthworm2.y=0,t.visState.visEarthworm2.height=a.taxheight});d3.select("#tombioEsbMultiaccess");this.worms=d3.select("#tombioEsbMultiaccess").selectAll(".tombioEsbWorm").data(e.d.taxa).enter().append("g").attr("x",0).attr("class","tombioEsbWorm").on("click",function(t){t.visState.visEarthworm2.height==a.taxheight?t.visState.visEarthworm2.height=a.taxexpanded:t.visState.visEarthworm2.height=a.taxheight,a.refresh()}),this.worms.append("rect").attr("x",0).attr("y",0).attr("rx",5).attr("ry",5).attr("height",this.taxheight).attr("width",this.taxwidth),this.worms.append("text").attr("x",0).attr("y",0).attr("class","tombioEsbScientificnames").style("opacity",0).text(function(t){return t.taxon.kbValue});for(var c=0;c<this.displayChars.length;c++)this.worms.append("text").attr("x",0).attr("y",0).attr("class","tombioEsbCharactervalue").style("opacity",0).attr("pointer-events","none").text(function(t){return a.displayChars[c].Label+": "+t[a.displayChars[c].Character].toString()});this.worms.append("image").attr("x",0).attr("y",0).attr("width",this.imagedim).attr("height",this.imagedim).style("opacity",0).attr("xlink:href",e.opts.tombiopath+"/visEarthworm2/resources/info20.png").attr("class","tombioEsbInfoimage").attr("id",function(t,e){return"tombioEsbInfoimage-"+e}).on("click",function(a,o){t(this).css("opacity")>0&&(d3.event.stopPropagation(),t("#tombioEsbPopup").dialog("open"),t("#tombioEsbPopupTitleText").html(a.taxon.kbValue),t("#tombioEsbInfoSpName").html(a.taxon.kbValue),t("#tombioEsbInfoSpAccount").html(a.AccountPage.kbValue),t("#tombioEsbInfoSpTable").html(a.TablePage.kbValue),t("#tombioEsbPopup").dialog("option","title",a.taxon.kbValue),function(a){t("#tombioEsbNbnLogo").attr("src",e.opts.tombiopath+"/visEarthworm2/resources/nbn-logo-centred.png").addClass("tombioEsbSpiningNbn"),t("#tombioEsbNbnLoading").show();var o="https://records-ws.nbnatlas.org/mapping/wms/image?baselayer=world&format=jpg&pcolour=3531FF&scale=on&popacity=1&q=*:*&fq=lsid:"+a+"&extents=-11.2538,48.6754,3.0270,60.7995&outline=false&outlineColour=0x000000&pradiusmm=1&dpi=200&widthmm=100";t("#tombioEsbMapDiv").html("<img id='tombioEsbPopupMap' width='100%' />"),t("#tombioEsbPopupMap").on("load",function(){t("#tombioEsbNbnLogo").attr("src",e.opts.tombiopath+"/visEarthworm2/resources/nbn-logo-colour-centred.png").removeClass("tombioEsbSpiningNbn"),t("#tombioEsbNbnLoading").hide()}).attr("src",o)}(a.tvk.kbValue))});for(c=1;c<=this.scoreChars.length;c++){var h=this.scoreChars[c-1],p=this.worms.append("g").attr("class","tombioEsbIndg");p.append("circle").attr("class","tombioEsbIndicator"+c).attr("cx",0).attr("cy",0).attr("r",function(){return"redline"==h.EsbScoreType?a.indrad:"segnum"==h.EsbScoreType?.8*a.indrad:.6*a.indrad}),p.append("text").attr("pointer-events","none").attr("class","tombioEsbIndText")}d3.select("#tombioEsbMultiaccess").style("width",2*this.taxwidth+3*this.taxspace),this.initialised=!0,e.f.checkInterface(o,e.templates.visTemplate,e.v.visualisations[o])},r.refresh=function(){function r(t,e){var a=String(Math.round(t,2)),o=String(Math.round(e,2)),r=m+"-"+a+"-"+o;if(r=r.replace(/ /g,""),!document.getElementById(r)){var i=d3.select("#tombioEsbMultiaccess").append("linearGradient").attr("id",r);i.append("stop").attr("offset","0%").attr("stop-color",b(t)),i.append("stop").attr("offset","100%").attr("stop-color",b(e))}return r}e.gui.main.contextMenu.addItem("Get URL for earthworm key",function(){var t;(t=[]).push("selectedTool="+o),Array.prototype.push.apply(t,e.f.setParamsFromControls()),e.f.createViewURL(t)},!1,[this.visName]);var l=this.scoreChars.filter(function(t){return t.stateSet}).length;l>0?t("#tombioEsbConfidenceLevelButton").show():t("#tombioEsbConfidenceLevelButton").hide();var c=d3.scaleLinear().domain([0,this.scoreChars.length/2,this.scoreChars.length]).range(e.d.scoreColours);t(".tombioEsbConfidenceLevel").css("background",c(l));var h=[],p=[];e.d.taxa.forEach(function(t){t.visState.visEarthworm2.redlineTotal=0,t.visState.visEarthworm2.segdiffTotal=0,a.scoreChars.forEach(function(e){"redline"==e.EsbScoreType&&(e.userInput&&t[e.Character].kbValue==e.CharacterStateValues[e.userInput]?t.visState.visEarthworm2.scores[e.Character]=0:e.userInput?(t.visState.visEarthworm2.scores[e.Character]=100,t.visState.visEarthworm2.redlineTotal+=100):t.visState.visEarthworm2.scores[e.Character]=null),"segnum"==e.EsbScoreType&&(t.visState.visEarthworm2.scores[e.Character]=function(t,e){if(""==t||null==t)return null;if(""==String(e))return null;if("n/a"==String(e))return t;if(0===String(e).indexOf("["))var a=e.substr(1,e.length-2),o=a.split("-"),r=Number(o[0]),i=Number(o[1]);else var r=Number(e),i=Number(e);return t<r?r-t:t>i?t-i:0}(e.userInput,t[e.Character].kbValue),t.visState.visEarthworm2.segdiffTotal+=t.visState.visEarthworm2.scores[e.Character]),"size"==e.EsbScoreType&&(t.visState.visEarthworm2.scores[e.Character]=function(t,e){if(""==t||null==t)return null;if(""==String(e))return null;if(0===String(e).indexOf("["))var a=e.substr(1,e.length-2),o=a.split("-"),r=Number(o[0]),i=Number(o[1]);else var r=Number(e),i=Number(e);return t<r?(r-t)/t<1?(r-t)/t:.48:t>i?(t-i)/t<1?(t-i)/t:.48:0}(e.userInput,t[e.Character].kbValue))}),t.visState.visEarthworm2.redlineTotal>0?p.push(t):t.visState.visEarthworm2.segdiffTotal>a.inputControl.otherState.tolerance?p.push(t):h.push(t)}),i(h,"lastPosInTaxain"),i(p,"lastPosInTaxaout");for(var u=0;u<h.length;u++)h[u].visState.visEarthworm2.lastPosInTaxain=u,h[u].visState.visEarthworm2.lastPosInTaxaout=u-100;for(u=0;u<p.length;u++)p[u].visState.visEarthworm2.lastPosInTaxaout=u,p[u].visState.visEarthworm2.lastPosInTaxain=100+u;var d=0;for(u=0;u<h.length;u++)h[u].visState.visEarthworm2.x=this.taxspace,h[u].visState.visEarthworm2.y=d+this.taxspace,d=h[u].visState.visEarthworm2.y+h[u].visState.visEarthworm2.height;for(d=0,u=0;u<p.length;u++)p[u].visState.visEarthworm2.x=this.taxwidth+2*this.taxspace,p[u].visState.visEarthworm2.y=d+this.taxspace,d=p[u].visState.visEarthworm2.y+p[u].visState.visEarthworm2.height;var m=e.v.visualisations.visEarthworm2.inputControl.otherState.colourby;if(m){var b,v,E,f=e.d.oCharacters[m].EsbColourParams.split(" ")[1];if("number"==f||"log"==f)v=e.d.oCharacters[m].minVal,E=e.d.oCharacters[m].maxVal,"log"==f&&(v=Math.log(v),E=Math.log(E)),b=d3.scaleLinear().domain([v,E]).range(["yellow","blue"]);else if("default"==f||"specified"==f){var g,y;"default"==f?(g=e.d.oCharacters[m].CharacterStateValues,y=(e.d.oCharacters[m].CharacterStateValues.length,d3.schemeCategory10)):(g=[],y=[],e.d.values.filter(function(t){return t.Character==m}).forEach(function(t){g.push(t.CharacterState),y.push(t.EsbColour.replace("*","#"))})),b=d3.scaleOrdinal().domain(g).range(y)}}e.d.taxa.forEach(function(t){if(m){if(""==t[m].kbValue)t.visState.visEarthworm2.fill="lightgrey";else if("number"==f||"log"==f){if((s=t[m].kbValue.trim()).startsWith("[")){var e=(s=s.substr(1,s.length-2)).split("-"),a=Number(e[0].trim()),o=Number(e[1].trim());"log"==f&&(a=Math.log(a),o=Math.log(o));var i="url(#"+r(a,o)+")";console.log("Gradient name: ",i),t.visState.visEarthworm2.fill=i}else t.visState.visEarthworm2.fill=b(t[m].kbValue)}else if("default"==f||"specified"==f){var s;if((e=(s=t[m].kbValue).split("|")).length>1){a=e[0].trim(),o=e[e.length-1].trim();t.visState.visEarthworm2.fill="url(#"+r(a,o)+")"}else t.visState.visEarthworm2.fill=b(t[m].kbValue)}}else t.visState.visEarthworm2.fill="lightgrey"}),this.worms.select("rect").style("opacity",.5).style("fill",function(t){return t.visState.visEarthworm2.fill}).transition().duration(1e3).delay(a.delay).attr("x",function(t){return t.visState.visEarthworm2.x}).attr("y",function(t){return t.visState.visEarthworm2.y}).attr("height",function(t){return t.visState.visEarthworm2.height}),this.worms.select(".tombioEsbScientificnames").transition().duration(1e3).delay(a.delay).style("opacity",1).attr("x",function(t){return t.visState.visEarthworm2.x+a.taxspace}).attr("y",function(t,e){return 1+t.visState.visEarthworm2.y+a.taxheight/2-2}),this.worms.select("text").text(function(t){return t.taxon.kbValue+" - "}).append("tspan").style("font-style","normal").style("font-weight","bold").style("font-size","0.9em").style("color","red").text(function(t){return t.visState.visEarthworm2.segdiffTotal}),this.worms.selectAll(".tombioEsbCharactervalue").transition().duration(1e3).delay(this.delay).style("opacity",function(t,e,o){return t.visState.visEarthworm2.height==a.taxheight?0:1}).attr("x",function(t){return t.visState.visEarthworm2.x+2*(a.taxspace+a.indrad)}).attr("y",function(t,e){return t.visState.visEarthworm2.y+a.taxheight+a.indrad-1+e*(2*(a.indrad+a.taxspace))}),this.worms.selectAll(".tombioEsbInfoimage").transition().duration(1e3).delay(this.delay).style("opacity",function(t,e,o){return t.visState.visEarthworm2.height==a.taxheight?0:1}).attr("x",function(t){return t.visState.visEarthworm2.x+a.taxwidth-a.imagedim-3}).attr("y",function(t,e){return t.visState.visEarthworm2.y+a.imagedim/2-2});var w=this.inputControl.otherState.tolerance,x=this.scoreChars.filter(function(t){return"redline"==t.EsbScoreType}).length,S=this.scoreChars.filter(function(t){return"segnum"==t.EsbScoreType}).length,C=d3.scaleLinear().domain([0,100]).range(["#0072B2","#D55E00"]),T=d3.scaleLinear().domain([0,w+1]).range(["#0072B2","#D55E00"]),I=d3.scaleLinear().domain([0,.48]).range(["#0072B2","#D55E00"]);this.worms.selectAll("circle").on("mouseover",s).on("mouseout",n).transition().duration(1e3).delay(a.delay).attr("cx",function(t,e,o){if(t.visState.visEarthworm2.height==a.taxheight){var r=a.scoreChars[e];if("redline"==r.EsbScoreType)var i=t.visState.visEarthworm2.x,s=(o=e,1);else if("segnum"==r.EsbScoreType)i=t.visState.visEarthworm2.x+x*(2*a.indrad+a.taxspace),o=e-x,s=.8;else i=t.visState.visEarthworm2.x+x*(2*a.indrad+a.taxspace)+S*(1.6*a.indrad+a.taxspace),o=e-x-S,s=.6;return i+a.taxspace+s*a.indrad+o*(2*s*a.indrad+a.taxspace)}return t.visState.visEarthworm2.x+a.taxspace+a.indrad}).attr("cy",function(t,e,o){return t.visState.visEarthworm2.height==a.taxheight?t.visState.visEarthworm2.y+a.taxheight-a.indrad-2:t.visState.visEarthworm2.y+a.taxheight+e*(2*(a.indrad+a.taxspace))}).style("fill",function(t,e){var o=a.scoreChars[e];return null!=t.visState.visEarthworm2.scores[o.Character]?e<2?C(t.visState.visEarthworm2.scores[o.Character]):e<8?t.visState.visEarthworm2.scores[o.Character]>w+1?T(w+1):T(t.visState.visEarthworm2.scores[o.Character]):t.visState.visEarthworm2.scores[o.Character]>1?1:I(t.visState.visEarthworm2.scores[o.Character]):"white"}),this.worms.selectAll(".tombioEsbIndText").text(function(t,e){var o=a.scoreChars[e];return null!=t.visState.visEarthworm2.scores[o.Character]&&"segnum"==o.EsbScoreType?t.visState.visEarthworm2.scores[o.Character]:""}),d3.select("#tombioEsbMultiaccess").transition().duration(1e3).delay(a.delay).attr("height",function(){var t,e;return t=0==p.length?0:p[p.length-1].visState.visEarthworm2.y+p[p.length-1].visState.visEarthworm2.height,e=0==h.length?0:h[h.length-1].visState.visEarthworm2.y+h[h.length-1].visState.visEarthworm2.height,Math.max(e,t)})},r.urlParams=function(t){},r.show=function(){t("#visEarthworm2").show(),t(r.inputControl.divSel).show(),r.inputControl.initFromCharacterState()},r.hide=function(){t("#visEarthworm2").hide(),t(r.inputControl.divSel).hide()}}(jQuery,this.tombiovis),function(t,e){"use strict";function a(t,a){e.f.refreshVisualisation()}function o(o){var i=e.gui.keyInputEarthworm.keyItemWidth,s=e.gui.keyInputEarthworm.keyItemHeight,n=e.gui.keyInputEarthworm.keyItemSpace,l=[];d3.select("#tombioEsbLegend").selectAll(".tombioesb-legenditem").remove();var c=t("#tombioEsbColourBy").val();if(""!=c){var h,p,u,d=e.d.oCharacters[c].EsbColourParams.split(" ")[1];if("number"==d||"log"==d)p=e.d.oCharacters[c].minVal,u=e.d.oCharacters[c].maxVal,"log"==d&&(p=Math.log(p),u=Math.log(u)),h=d3.scaleLinear().domain([p,u]).range(["yellow","blue"]),l=[{colval:"url(#"+r("yellow","blue",p+"-"+u)+")",coltext:e.d.oCharacters[c].Label,coltitle:"Range is "+e.d.oCharacters[c].minVal+"-"+e.d.oCharacters[c].maxVal}];else if("default"==d||"specified"==d){var m,b;"default"==d?(m=e.d.oCharacters[c].CharacterStateValues,b=e.d.oCharacters[c].CharacterStateValues.length<=10?d3.schemeCategory10:d3.schemeCategory20):(m=[],b=[],e.d.values.filter(function(t){return t.Character==c}).forEach(function(t){m.push(t.CharacterState),b.push(t.EsbColour.replace("*","#"))})),h=d3.scaleOrdinal().domain(m).range(b),l=m.map(function(t){return{colval:h(t),coltext:t}})}var v=d3.select("#tombioEsbLegend").selectAll(".tombioesb-legenditem").data(l).enter().append("g").attr("class","tombioesb-legenditem");v.append("rect").attr("class","tombioEsbLegendRect").attr("x",0).attr("y",function(t,e){return n+e*(s+n)}).attr("rx",5).attr("ry",5).attr("height",s).attr("width",i).style("opacity",.5).attr("fill",function(t){return t.colval}).attr("title",function(t){return t.coltitle?t.coltitle:""}),v.append("text").attr("class","tombioEsbLegendText").attr("x",n).attr("y",function(t,e){return n+e*(s+n)+2*s/3}).text(function(t){return t.coltext}).attr("title",function(t){return t.coltitle?t.coltitle:""}),t(".tombioEsbLegendRect[title!='']").tooltip({track:!0}),t(".tombioEsbLegendText[title!='']").tooltip({track:!0})}d3.select("#tombioEsbLegend").style("height",n+l.length*(s+n)),a()}function r(t,e,a){var o=a.replace("[","").replace("]","").replace(/,/g,"").replace(/ /g,""),r=d3.select("#tombioEsbLegend").append("linearGradient").attr("id",o);return r.append("stop").attr("offset","0%").attr("stop-color",t),r.append("stop").attr("offset","100%").attr("stop-color",e),o}e.gui.keyInputEarthworm={width:280,otherState:{keys:["colourby","tolerance"],colourby:null,tolerance:null},keyItemWidth:130,keyItemHeight:30,keyItemSpace:5},e.gui.keyInputEarthworm.init=function(r){var i,s,n,l,c,h,p=this;t("<div>").attr("id","tombioEsbKeyInput").appendTo(r);this.divSel="#tombioEsbKeyInput",(i=t("<table>").attr("id","tombioEsbControlsTable")).appendTo(t("#tombioEsbKeyInput")),s=t("<tr>").appendTo(i),t("<td>").appendTo(s),n=t("<td>").attr("colspan","2").appendTo(s),(l=t("<button>").attr("id","tombioEsbOptions").text("Options").appendTo(n)).button({icons:{primary:null,secondary:"ui-icon-options"},disabled:!1}).click(function(e){t("#tombioEsbOptionsDialog").dialog("open")}),s=t("<tr>").appendTo(i),t("<td>").appendTo(s),n=t("<td>").attr("colspan","2").appendTo(s),(l=t("<button>").attr("id","tombioEsbReset").text("Reset all").appendTo(n)).button({icons:{primary:null,secondary:"ui-icon-reset"}}).click(function(r){t(".tombioEsbInputSpin").val("").spinner("value",""),t(".tombioEsbInputMenu").val("").selectmenu("refresh"),e.d.characters.forEach(function(t){t.stateSet=!1,t.userInput=null}),a(),t("#tombioEsbColourBy").val("").selectmenu("refresh"),p.otherState.colourby="",o()}),e.d.characters.filter(function(t){return""!=t.EsbKeyOrder}).sort(function(t,e){return t.EsbKeyOrder-e.EsbKeyOrder}).forEach(function(o){if(s=t("<tr>").appendTo(i),(n=t("<td>").attr("morphokey",o.EsbMorphoKey).appendTo(s)).addClass("tombioEsbMorphoLabel").text(o.Label).appendTo(n),n=t("<td>").appendTo(s),"spin"==o.ControlType?(c=t("<input>")).addClass("tombioEsbInputSpin"):(c=t("<select>"),"multi"==o.ControlType&&c.attr("multiple","multiple"),c.addClass("tombioEsbInputMenu")),c.addClass("tombioEsbInput").attr("id","tombioEsbInput-"+o.Character).appendTo(n),n=t("<td>").appendTo(s),h=t("<img>").attr("src",e.opts.tombiopath+"/visEarthworm2/resources/reset2.png").addClass("tombioEsbResetImage").attr("id","tombioEsbReset-"+o.Character).appendTo(n),"spin"==o.ControlType){var r=o.Params.split(","),p=Number(r[0]),u=Number(r[1]),d=Number(r[2]);c.spinner({min:p,max:u,step:d}).on("spinstop",function(e,r){var i=t("#tombioEsbInput-"+o.Character).spinner("value");o.stateSet=null!=i&&""!=i,o.userInput=i,a()}),h.click(function(){t("#tombioEsbInput-"+o.Character).val("").spinner("value",""),o.stateSet=!1,o.userInput=null,a()})}else c.attr("name","tombioEsbInput-"+o.Character),l=t("<option>").attr("value","").attr("selected","selected").text(""),c.append(l),o.CharacterStateValues.forEach(function(e){l=t("<option>").text(e),c.append(l)}),c.selectmenu().on("selectmenuchange",function(){var e=o.CharacterStateValues.indexOf(t("#tombioEsbInput-"+o.Character).val());-1==e?(o.stateSet=!1,o.userInput=null):(o.stateSet=!0,o.userInput=[e]),a()}),h.click(function(){t("#tombioEsbInput-"+o.Character).val("").selectmenu("refresh"),o.stateSet=!1,o.userInput=null,a()})}),s=t("<tr>").appendTo(i),n=t("<td>").addClass("tombioEsbMorphoLabelNoLink").text("Colour by").appendTo(s),n=t("<td>").appendTo(s),c=t("<select>").attr("id","tombioEsbColourBy").addClass("tombioEsbInputMenu").appendTo(n),l=t("<option>").attr("value","").attr("selected","selected").text("").appendTo(c),e.d.characters.filter(function(t){return""!=t.EsbColourParams}).sort(function(t,e){return t.EsbColourParams.split(" ")[0]-e.EsbColourParams.split(" ")[0]}).forEach(function(e){l=t("<option>").attr("value",e.Character).text(e.Label).appendTo(c)}),c.selectmenu().on("selectmenuchange",function(){p.otherState.colourby=t("#tombioEsbColourBy").val(),o()}),n=t("<td>").appendTo(s),(h=t("<img>").attr("src",e.opts.tombiopath+"/visEarthworm2/resources/reset2.png").addClass("tombioEsbResetImage").attr("id","tombioEsbReset-colour").appendTo(n)).click(function(){t("#tombioEsbColourBy").val("").selectmenu("refresh"),p.otherState.colourby="",o()}),s=t("<tr>").appendTo(i),t("<td>").appendTo(s),n=t("<td style='display:flex'>").appendTo(s),(l=t('<svg xmlns="http://www.w3.org/2000/svg" version="1.1">').attr("id","tombioEsbLegend").appendTo(n)).css("width",this.keyItemWidth).css("height",0),t(".tombioEsbMorphoLabel").hover(function(){t(this).animate({color:"#D55E00"},"fast")},function(){t(this).animate({color:"black"},"fast")}).click(function(){var e=t('#tombioEsbHelpTabs a[href="#tombioEsbHelpTab-'+t(this).attr("morphokey")+'"]').parent().index();t("#tombioEsbHelpTabs").tabs("option","active",e),t("#tombioEsbHelpDialog").dialog("open")}),t("<div>").attr("id","tombioEsbOptionsDialog").appendTo(t("#tombioEsbKeyInput")),i=t("<table>").appendTo(t("#tombioEsbOptionsDialog")),s=t("<tr>").appendTo(i),n=t("<td>").text("Tolerance").appendTo(s),n=t("<td>").appendTo(s),t("<input>").attr("id","tombioEsbTolerance").appendTo(n),t("<p>").text("(Consult the information dialog for details of how the tolerance value affects the display of species in the 'possible species' and 'unlikely species' lists.)").appendTo(t("#tombioEsbOptionsDialog")),t("#tombioEsbOptionsDialog").dialog({title:"Options",autoOpen:!1,modal:!0,width:410,height:200,show:{effect:"slideDown",duration:500},hide:{effect:"explode",duration:500}}),t("#tombioEsbTolerance").spinner({min:0,max:5,step:1}).on("spinstop",function(){p.otherState.tolerance=t("#tombioEsbTolerance").spinner("value"),a()}),t("#tombioEsbTolerance").spinner("value",2),this.otherState.tolerance=2,t.get(e.opts.tombiopath+"/visEarthworm2/characterHelp.html",function(a){t("#tombioEsbKeyInput").append(a.replace(/##tombiopath##/g,e.opts.tombiopath)),t("#tombioEsbHelpDialog").dialog({title:"Morphological features",width:600,height:470,autoOpen:!1,modal:!0,show:{effect:"slideDown",duration:500},hide:{effect:"explode",duration:500}}),t("#tombioEsbHelpTabs").tabs()}),setTimeout(e.gui.main.resizeControlsAndTaxa,100),e.f.checkInterface("keyInputEarthworm",e.templates.gui.keyInput,e.gui.keyInputEarthworm)},e.gui.keyInputEarthworm.initFromCharacterState=function(){e.d.characters.forEach(function(e,a){if("spin"===e.ControlType){(o=t("#tombioEsbInput-"+e.Character)).spinner("value",e.stateSet?e.userInput:"")}else{var o=t("#tombioEsbInput-"+e.Character);if(e.stateSet){var r=e.userInput.map(function(t){return e.CharacterStateValues[t]});if(0==r.length)var i="";else i=r[0]}else i="";o.val(i).selectmenu("refresh")}})},e.gui.keyInputEarthworm.initStateFromParams=function(e){this.initFromCharacterState(),t("#tombioEsbTolerance").spinner("value",e.tolerance),t("#tombioEsbColourBy").val(e.colourby).selectmenu("refresh"),this.otherState.colourby=e.colourby,o()},e.gui.keyInputEarthworm.setParamsFromState=function(t){return t.push("colourby="+this.otherState.colourby),t.push("tolerance="+this.otherState.tolerance),t}}(jQuery,this.tombiovis.templates.loading?this.tombiovis.templates:this.tombiovis);