!function(e,t){"use strict";t.d.stateValue={v:null},t.d.stateValue.init=function(e,a){var o=t.d.oCharacters[a];this.valueType=o.ValueType,this.status=o.Status,this.character=o.Character;var n,i=this;this.v.trim().split("|").forEach(function(e,r){var s,l;if((e=e.trim()).endsWith("(m)")||e.endsWith("(f)")?(s=e.substr(0,e.length-4).trim(),l=e.substr(e.length-4,4)):(s=e,l=""),o.stateGroups&&o.stateGroups.indexOf(s)>-1){var c=[];t.d.values.forEach(function(e){e.Character==a&&e.StateGroup==s&&c.push(e.CharacterState)})}else c=[s];c.forEach(function(e){var t=i.translateStateValue(i.character,e);""!=l&&(t=t+" "+l),n=n?n+" | "+t:t}),n.length>0&&"#"==n.substr(0,1)&&(n=""),"?"==n.length&&(n="")}),this.kbValue=n,"key"==o.Status&&(this.score={na:0,for:0,against:0,overall:0})},t.d.stateValue.translateStateValue=function(e,a){function o(e,a){var o=t.d.values.filter(function(t){return t.Character==e&&t.CharacterState.trim()==a});if(o[0]&&o[0].CharacterStateTranslation&&""!=o[0].CharacterStateTranslation)var n=o[0].CharacterStateTranslation;else n=a;return n}if(/^\[[^-]+-[^-]+\]$/.test(a)){var n=a.substr(1,a.length-2).split("-");return"["+o(e,n[0])+"-"+o(e,n[1])+"]"}return o(e,a)},t.d.stateValue.getStates=function(e){e||(e="");for(var t=[],a=this.kbValue.split("|"),o=0;o<a.length;o++){var n=a[o];"n/a"!=(n=n.trim())&&"novalue"!=n&&"?"!=n&&""!=n&&("male"!=e||n.endsWith("(f)")?"female"!=e||n.endsWith("(m)")?""==e&&t.push(n.replace("(m)","").replace("(f)","").trim()):t.push(n.replace("(f)","").trim()):t.push(n.replace("(m)","").trim()))}return t},t.d.stateValue.getRange=function(){var e={};if(""==String(this.kbValue)?e.hasValue=!1:e.hasValue=!0,0==String(this.kbValue).indexOf("[")){var t=this.kbValue.substr(1,this.kbValue.length-2).split("-");e.min=Number(t[0]),e.max=Number(t[1]),e.mid=e.min+(e.max-e.min)/2}else e.min=Number(this.kbValue),e.max=Number(this.kbValue),e.mid=Number(this.kbValue);return e},t.d.stateValue.getOrdinalRanges=function(e){var a=this,o=[];return"ordinal"!=this.valueType&&"ordinalcircular"!=this.valueType||this.getStates(e).forEach(function(e){var n=[];if(0==e.indexOf("[")){var i=e.substr(1,e.length-2).split("-"),r=i[0],s=i[1],l=!1;t.d.oCharacters[a.character].CharacterStateValues.forEach(function(e){e==r&&(l=!0),l&&n.push(e),e==s&&(l=!1)}),l&&t.d.oCharacters[a.character].CharacterStateValues.forEach(function(e){l&&n.push(e),e==s&&(l=!1)})}else n.push(e);o.push(n)}),o},t.d.stateValue.toHtml1=function(){if("n/a"==this.kbValue)return"<i>not applicable</i>";if("novalue"==this.kbValue)return"<i>not manifest</i>";if(""==this.kbValue||"?"==this.kbValue)return"<i>no value specified</i>";if("text"==this.valueType||"ordinal"==this.valueType||"ordinalcircular"==this.valueType)return t=(t=(t=(t=(t=(t=this.kbValue.replace(/([^|]+)/g,"<b>$1</b>")).replace(/(\(m\)\s*<\/b>)/g,"</b> (male)")).replace(/(\(f\)\s*<\/b>)/g,"</b> (female)")).replace(/<b>\s*\[/g,"<b>")).replace(/\]\s*<\/b>/g,"</b>")).replace(/\s*\|\s*/g," or "),"display"==this.status&&(t=t.replace(/<b>/g,"").replace(/<\/b>/g,"")),t;if("numeric"==this.valueType){var e=this.getRange();if(0==e.hasValue)var t="<b>no value in knowledge-base</b>";else if(e.min==e.max)t="<b>"+e.min+"</b>";else t="<b>"+e.min+"-"+e.max+"</b> (range)";return"display"==this.status&&(t=t.replace(/<b>/g,"").replace(/<\/b>/g,"")),t}return this.kbValue},t.d.stateValue.toHtml2=function(e){var t="<li>",a="</li>";if(e&&(t="",a=""),"n/a"==this.kbValue)return"<li><i>not applicable</i></li>";if("novalue"==this.kbValue)return"<li><i>not manifest</i></li>";if("text"==this.valueType||"ordinal"==this.valueType||"ordinalcircular"==this.valueType){for(var o="",n=this.kbValue.split("|"),i=0;i<n.length;i++){var r=n[i].trim();r=(r=(r=/\(m\)$/.test(r)?"<b>"+r.replace(/\(m\)$/,"</b> (male)"):/\(f\)$/.test(r)?"<b>"+r.replace(/\(f\)$/,"</b> (female)"):"<b>"+r.trim()+"</b>").replace(/<b>\s*\[/g,"<b>")).replace(/\]\s*<\/b>/g,"</b>"),i<n.length-1&&(r+=" <i>or</i> "),o+=t,o+=r,o+=a}return o}if("numeric"==this.valueType){var s=this.getRange();return 0==s.hasValue?t+"<i>no value in knowledge-base</i>"+a:s.min==s.max?t+"<b>"+s.min+"</b>"+a:t+"<b>"+s.min+" - "+s.max+"</b> (range)"+a}return this.kbValue},t.d.stateValue.toString=function(){return this.kbValue}}(jQuery,this.tombiovis),function(e,t){"use strict";function a(){return t.v.selectedTool in t.v.visualisations?t.v.visualisations[t.v.selectedTool]:null}t.f.loadcomplete=function(a){if(e("#tombiod3-header").text(t.d.kbmetadata.title),e("#tombiod3-footer").html(t.f.getCitation(t.d.kbmetadata,"Knowledge-base",t.d.softwareMetadata.title)),a||t.f.checkKnowledgeBase()){t.d.values.forEach(function(e){e.CharacterStateTranslation&&(e.CharacterStateTranslation=e.CharacterStateTranslation.replace(/ +(?= )/g,""))}),t.d.oCharacters={},t.d.characters.forEach(function(e){t.d.oCharacters[e.Character]=e,e.CharacterStates=[],e.CharacterStateValues=[],e.stateSet=!1,e.userInput=null,e.minVal=null,e.maxVal=null,"key"==e.Status&&"none"!=e.Group.toLowerCase()&&(t.d.oCharacters.grouped=!0),e.stateGroups=[],t.d.values.forEach(function(t){t.Character==e.Character&&t.StateGroup&&-1==e.stateGroups.indexOf(t.StateGroup)&&e.stateGroups.push(t.StateGroup)})}),t.d.groupedCharacters={},t.d.groupedCharacters.groups=[],t.d.characters.forEach(function(e){"key"==e.Status&&(t.d.groupedCharacters[e.Group]||(t.d.groupedCharacters[e.Group]=[],t.d.groupedCharacters.groups.push(e.Group)),t.d.groupedCharacters[e.Group].push(e))}),t.d.oTaxa={};var o=0;t.d.taxa.forEach(function(e){for(var a in t.d.oTaxa[e.taxon]=e,e)e.hasOwnProperty(a)&&(e[a]=Object.create(t.d.stateValue,{v:{writable:!0,value:e[a]}}),e[a].init(e,a));e.kbPosition=++o,e.visState={score:{for:null,against:null,overall:null}}}),t.d.characters.forEach(function(e){if("numeric"==e.ValueType&&t.d.taxa.forEach(function(t){var a=t[e.Character].getRange().min,o=t[e.Character].getRange().max;(!e.minVal||a<e.minVal)&&(e.minVal=a),(!e.maxVal||o>e.maxVal)&&(e.maxVal=o)}),"numeric"==e.ValueType||"ordinal"==e.ValueType||"ordinalcircular"==e.ValueType)if(void 0!==e.Latitude)e.Latitude=Number(e.Latitude);else{var a=""==e.Strictness?10:Number(e.Strictness);if("numeric"==e.ValueType)e.Latitude=(1-a/10)*(e.maxVal-e.minVal);else{var o=t.d.values.filter(function(t){return t.Character==e.Character}).length;e.Latitude=(1-a/10)*o,"ordinalcircular"==e.ValueType&&(e.Latitude=e.Latitude/2)}}}),t.d.media.forEach(function(e){"html-local"==e.Type?e.URI=t.opts.tombiokbpath+e.URI+"?t=kbtxt":"image-local"==e.Type&&(e.URI=t.opts.tombiokbpath+e.URI+"?t=kbimgstd",e.SmallURI&&(e.SmallURI=t.opts.tombiokbpath+e.SmallURI+"?t=kbimgsml"),e.LargeURI&&(e.LargeURI=t.opts.tombiokbpath+e.LargeURI+"?t=kbimglrg"))}),t.d.values.forEach(function(e){var a=t.d.oCharacters[e.Character];if(a){if(e.CharacterStateTranslation&&""!=e.CharacterStateTranslation)var o=e.CharacterStateTranslation;else var o=e.CharacterState;-1==a.CharacterStateValues.indexOf(o)&&(a.CharacterStates.push({CharacterState:o,StateHelp:e.StateHelp,StateHelpShort:e.StateHelpShort}),a.CharacterStateValues.push(o))}}),t.d.characters.forEach(function(e){("taxonomy"==e.Group.toLowerCase()||"key"==e.Status&&"text"==e.ValueType)&&t.d.taxa.forEach(function(t){var a=t[e.Character].getStates("");a.forEach(function(t){""!=t&&-1==e.CharacterStateValues.indexOf(t)&&(e.CharacterStates.push({CharacterState:t,StateHelp:""}),e.CharacterStateValues.push(t))})})});var n=t.f.getURLParameter("selectedTool");n?t.v.selectedTool=n:t.opts.selectedTool?t.v.selectedTool=t.opts.selectedTool:t.d.kbconfig.selectedTool?t.v.selectedTool=t.d.kbconfig.selectedTool:t.v.selectedTool=t.v.includedVisualisations[0],t.gui.main.init(),t.gui.main.createUIControls(),e("#downloadspin").remove(),t.f.resizeControlsAndTaxa(),t.f.visChanged(t.v.selectedTool),t.loadCallback&&t.loadCallback()}},t.f.cacheAll=function(){console.log("caching all");var e=0,a=0,o=[];t.opts.tools.forEach(function(e){console.log("Caching tool "+e);var n=t.js.jsFiles[e].loadJs().then(function(){console.log("Tool "+e+" successfully cached.")}).catch(function(){console.log("Tool "+e+" unsuccessfully cached.")});a+=1,d(n),o.push(n)});var n=[];n.push(t.opts.tombiokbpath+"info.html");var i=t.opts.tombiopath+"common/",r=[];r.push(i+"character-help.png"),r.push(i+"character-input.png"),r.push(i+"full-details.html"),r.push(i+"nbn-map.jpg"),r.push(i+"stateInputHelp.html"),r.push(i+"taxon-details-2.png"),r.push(i+"taxon-select-help.html"),r.push(i+"taxon-select.png"),r.push(i+"taxonDetailsHelp.html"),r.push(i+"text-selection-input.png");var s=t.d.media.filter(function(e){return e.SmallURI&&"image-local"==e.Type}).map(function(e){return e.SmallURI}),l=t.d.media.filter(function(e){return e.URI&&"image-local"==e.Type}).map(function(e){return e.URI}),c=t.d.media.filter(function(e){return e.LargeURI&&"image-local"==e.Type}).map(function(e){return e.LargeURI}),u=t.d.media.filter(function(e){return e.URI&&"html-local"==e.Type}).map(function(e){return e.URI});function d(o){o.then(function(){e+=1,t.gui.main.updateProgress(100*e/a)})}function p(e,t,o){return a+=e.length,caches.open(t).then(function(t){console.log("Caching "+o);var a=[];return e.forEach(function(e){var o=t.add(e);d(o),a.push(o)}),Promise.all(a).then(function(){console.log("Sucessfully cached "+o)}).catch(function(){console.log("One or more files failed to cache "+o)})})}o.push(p(s,"tombio-kb-img-sml-cache-1","small images from knowledge-base")),o.push(p(l,"tombio-kb-img-std-cache-1","standard images from knowledge-base")),o.push(p(c,"tombio-kb-img-lrg-cache-1","large images from knowledge-base")),o.push(p(u,"tombio-kb-txt-cache-1","text files from knowledge-base")),o.push(p(n,"tombio-kb-cache-1","core knowledge-base")),o.push(p(r,"tombio-gen-cache-1","common help resources")),Promise.all(o).then(function(){console.log("All caches completed"),t.gui.main.offerRefresh()}).catch(function(){console.log("Not all caches completed successfully")})},t.f.visChanged=function(e,a){if(e){if(t.opts.devel&&t.templates.visTemplate.initP("visTemplate"),t.v.selectedTool=e,"reload"==e)return caches?void caches.keys().then(function(e){return Promise.all(e.map(function(e){if(e.startsWith("tombio-"))return console.log("[ServiceWorker] Removing cache",e),caches.delete(e)}))}).then(function(){window.location.reload()}):void window.location.reload(!0);if("reloadkb"!=e)if("reloadGuiOnsen"!=e)if("reloadGuiJQuery"!=e)if("offline"!=e)if("visInfo"!=e&&"kbInfo"!=e){var o;if("tombioCitation"==e||"currentVisInfo"==e)return o=a||(t.v.lastVis?t.v.lastVis:t.opts.lastVisualisation?t.opts.lastVisualisation:t.v.includedVisualisations[0].visName),t.f.showDownloadSpinner(),void t.js.jsFiles[o].loadJs().then(function(){if(t.f.hideDownloadSpinner(),!t.v.visualisations[o].initialised){var a=t.v.visualisations[o];a.initP(o),a.hide()}t.v.lastVis=o,t.gui.main.visShow(e)});"mediaFilesCheck"!=e&&"tvkCheck"!=e?(t.f.showDownloadSpinner(),t.js.jsFiles[e].loadJs().then(function(){(t.f.hideDownloadSpinner(),t.v.visualisations[e].initialised)||t.v.visualisations[e].initP(e);console.log("Starting",e),t.gui.main.visShow(e),setTimeout(function(){t.v.visualisations[e].refresh()},100)}).catch(function(a){console.log("Error",a);var o="";o+="<p>You are working offline but the tool you tried to load( "+e+") was not previously loaded into memory.</p>",o+="<p>Load the tool when you next have an internet connection. Then you will be able to use it offline.</p>",t.gui.main.dialog("Currently unavailable",o)}),t.gui.main.setSelectedTool(e)):t.gui.main.visShow(e)}else t.gui.main.visShow(e);else t.gui.main.offlineOptions();else{location.pathname;window.location.replace(location.pathname+"?gui=guiLargeJqueryUi")}else{location.pathname;window.location.replace(location.pathname+"?gui=guiOnsenUi")}else caches?caches.keys().then(function(e){return Promise.all(e.map(function(e){if(e.startsWith("tombio-kb-"))return console.log("[ServiceWorker] Removing cache",e),caches.delete(e)}))}).then(function(){window.location.reload()}):window.location.reload(!0)}},t.f.initControlsFromParams=function(e){for(name in e)if(name.startsWith("c-")){var o=name.split("-")[1],n=t.d.characters[o];"spin"===n.ControlType?n.userInput=e[name]:n.userInput=e[name].split(","),n.stateSet=!0}a().inputControl.initStateFromParams(e),t.f.refreshVisualisation()},t.f.setParamsFromControls=function(){var e=[];return t.d.characters.forEach(function(t,a){if(t.userInput){var o="c-"+a;"spin"===t.ControlType?e.push(o+"="+t.userInput):e.push(o+"="+t.userInput.join(","))}}),a().inputControl.setParamsFromState(e)},t.f.getCitation=function(t,a,o){var n,i=e("<div class='tombioCitation'>"),r=new Date;return n=t.authors+" ",n+="("+t.year+") ",n+="<i>"+t.title+"</i>",n+=" (Version "+t.version+") ["+a+"]",o&&(n+=" (for "+o+")"),n+=". ",t.publisher&&(n+=t.publisher+". "),t.location&&(n+=t.location+". "),n+="Accessed "+r.toDateString()+". ",n+=window.location.href.split("?")[0],i.append(e("<div>").html(n)),i},t.f.setKbInfo=function(a){e.get(t.opts.tombiokbpath+"info.html",function(e){a.append(e.replace(/##tombiopath##/g,t.opts.tombiopath).replace(/##tombiokbpath##/g,t.opts.tombiokbpath))}).always(function(){var o=e("<h3>").attr("id","tombioKbCitation").text("Citation");a.append(o),a.append(t.f.getCitation(t.d.kbmetadata,"Knowledge-base",t.d.softwareMetadata.title));var n=e("<h3>").attr("id","tombioKbRevisionHistory").text("Knowledge-base revision history");a.append(n);var i=e("<p>").html("<b>Current version: "+t.d.kbmetadata.version+"</b>");a.append(i);var r=e("<table>"),s=e("<tr>").css("background-color","black").css("color","white");s.append(e("<td>").text("Date").css("padding","3px")),s.append(e("<td>").text("Version").css("padding","3px")),s.append(e("<td>").text("Notes").css("padding","3px")),r.append(s),t.d.kbreleaseHistory.forEach(function(t,a){s=e("<tr>"),a%2==0?s.css("background-color","rgb(200,200,200)"):s.css("background-color","rgb(230,230,230)");var o=new Date(t.Date);s.append(e("<td>").css("padding","3px").text(o.getDate()+"/"+(o.getMonth()+1)+"/"+o.getFullYear())),s.append(e("<td>").css("padding","3px").text(t.Value)),s.append(e("<td>").css("padding","3px").text(t.Notes)),r.append(s)}),a.append(r)})},t.f.setVisInfo=function(a){e.get(t.opts.tombiopath+"visInfo.html",function(e){a.html(e.replace(/##tombiopath##/g,t.opts.tombiopath).replace(/##tombiokbpath##/g,t.opts.tombiokbpath))})},t.f.setSelectedToolInfo=function(a){var o=new Array(t.v.visualisations[t.v.lastVis].helpFiles.length),n=[];t.v.visualisations[t.v.lastVis].helpFiles.forEach(function(t,a){n.push(new Promise(function(n,i){e.get(t,function(e){o[a]=e,n()})}))}),Promise.all(n).then(function(){var e="";o.forEach(function(t){e+=t}),e=e.replace(/##tombiopath##/g,t.opts.tombiopath).replace(/##tombiokbpath##/g,t.opts.tombiokbpath),a.html(e)})},t.f.createCitationPage=function(){var a,o=e("<div>");o.append(e("<h3>").text("Citation for FSC Identikit (core software)")),a="This is the reference you can use for the FSC Identikit - in other words the core software.",a+=" The core version number is updated whenever there is a new major release of the core software.",o.append(e("<p>").html(a)),o.append(e("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='tbCitationCore' id='tbCitationCore'>")),o.append(e("<span>").text("Copy citation")),o.append(e("<b>").html(t.f.getCitation(t.d.softwareMetadata,"Software"))),o.append(e("<h3>").text("Citation for knowledge-base")),a="This is the reference you can use for the knowledge-base currently driving the software.",a+=" The knowledge-base version number is updated whenever there is a new release of the knowledge-base.",o.append(e("<p>").html(a)),o.append(e("<input style='position: relative; top: 0.2em' checked='checked' type='checkbox' name='tbCitationKb' id='tbCitationKb'>")),o.append(e("<span>").text("Copy citation")),o.append(e("<b>").html(t.f.getCitation(t.d.kbmetadata,"Knowledge-base",t.d.softwareMetadata.title)));var n=e("<button>Copy citations</button>");return n.button(),n.click(function(){e("#tbSelectedCitations").html(""),document.getElementById("tbCitationCore").checked&&e("#tbSelectedCitations").append(t.f.getCitation(t.d.softwareMetadata,"Software")),document.getElementById("tbCitationKb").checked&&e("#tbSelectedCitations").append(t.f.getCitation(t.d.kbmetadata,"Knowledge-base",t.d.softwareMetadata.title)),t.f.selectElementText(document.getElementById("tbSelectedCitations")),e("#tbCitationInstructions").show()}),o.append(e("<p>").append(n).append("&nbsp;The selected citations will appear together below - just copy and paste")),o.append(e("<div id='tbSelectedCitations'>")),o.append(e("<p id='tbCitationInstructions' style='display: none'>").text("You can now copy and paste the selected citation text.")),o},t.f.refreshVisualisation=function(){var o;o=e("#Sex").val(),t.d.taxa.forEach(function(e){e.visState.score.for=0,e.visState.score.against=0,e.visState.score.overall=0,e.visState.score.charFor=0,e.visState.score.charAgainst=0,e.visState.score.charNeutral=0,e.visState.score.charUsed=0,t.d.characters.filter(function(e){return"key"==e.Status}).forEach(function(a){var n,i,r,s,l=a.Character;if(a.stateSet){if("numeric"==a.ValueType)if(""==e[l])n=0,s=0,i=0,r=0;else if("n/a"==e[l])n=1,s=t.opts.ignoreNegativeScoring?0:1,i=0,r=0;else if("novalue"==e[l])n=1,s=0,i=0,r=t.opts.ignoreNegativeScoring?0:1;else{var c=Number(a.userInput),u=e[l].getRange(),d=(a.maxVal,a.minVal,t.f.score.numberVsRange(c,u,a.Latitude));i=d[0],r=d[1],n=1,s=0}else if("ordinal"==a.ValueType||"ordinalcircular"==a.ValueType||"text"==a.ValueType)if("n/a"==e[l])n=1,s=t.opts.ignoreNegativeScoring?0:1,i=0,r=0;else if("novalue"==e[l])n=1,s=0,i=0,r=1;else{var p=a.userInput.map(function(e){return a.CharacterStateValues[e]});if("ordinal"==a.ValueType||"ordinalcircular"==a.ValueType)var h=e[l].getOrdinalRanges(o),f=a.CharacterStateValues,m="ordinalcircular"==a.ValueType,d=t.f.score.ordinal(p,h,f,a.Latitude,m);else if("Sex"==l)var d=[0,0];else var h=e[l].getStates(o),d=t.f.score.character(p,h);i=d[0],r=d[1],n=1,s=0}}else n=0,s=0,i=0,r=0;e[l].score.na=s,e[l].score.for=i,e[l].score.against=r,e[l].score.overall=i-r-s;var g=Number(a.Weight)/10;e.visState.score.for+=i*g,e.visState.score.against+=r*g,e.visState.score.against+=s*g,e.visState.score.overall+=(i-r-s)*g,1==n&&(i-r-s>0?e.visState.score.charFor+=1:e.visState.score.charAgainst+=1),e.visState.score.charUsed+=n})}),a()&&a().refresh(),t.f.resizeControlsAndTaxa()},t.f.resizeControlsAndTaxa=function(){t.gui.main.resizeControlsAndTaxa()},t.f.characterHasHelp=function(e){return t.d.oCharacters[e].Help.length>0||(t.d.values.filter(function(t){if(t.Character==e&&t.StateHelp)return!0}).length>0||t.d.media.filter(function(t){if(("image-local"==t.Type||"image-web"==t.Type)&&t.Character==e)return!0}).length>0)},t.f.getURLParameter=function(e){for(var t=window.location.search.substring(1).split("&"),a=0;a<t.length;a++){var o=t[a].split("=");if(o[0]==e)return o[1]}return null},t.f.createMediaCheckPage=function(){var a=e("<div id='tombioMediaChecks'>"),o=e("<h2>").appendTo(a),n=e("<div id='tombioMediaNotFound'>").appendTo(a),i=e("<div id='tombioMediaFound'>").appendTo(a);return n.append("<h3>Not found</h3>"),n.append("<p>If a file cannot be found but you think it is present, check the case carefully. The case used to name the file must match exactly the case used in the knowledge-base. For example, a file with extension '.JPG' will not match the same filename in the knowledge-base if it is written there as '.jpg'.</p>"),i.append("<h3>Found</h3>"),o.text("Checking media files..."),t.f.mediaCheck("URI",function(t){e("#tombioMediaFound").append(e("<p>").html("The media file '"+t+"' found okay."))},function(t){e("#tombioMediaNotFound").append(e("<p>").html("The media file '"+t+"' cannot be found."))}).then(function(){t.f.mediaCheck("SmallURI",function(t){e("#tombioMediaFound").append(e("<p>").html("The small media file '"+t+"' found okay."))},function(t){e("#tombioMediaNotFound").append(e("<p>").html("The small media file '"+t+"' cannot be found."))})}).then(function(){t.f.mediaCheck("LargeURI",function(t){e("#tombioMediaFound").append(e("<p>").html("The large media file '"+t+"' found okay."))},function(t){e("#tombioMediaNotFound").append(e("<p>").html("The large media file '"+t+"' cannot be found."))})}).then(function(){o.text("Completed checking media files")}),a},t.f.createTvkCheckPage=function(){var a=e("<div id='tombioTvkChecks'>"),o=e("<h2>").appendTo(a),n=e("<div id='tombioTvkNotFound'>").appendTo(a),i=e("<div id='tombioTvkFound'>").appendTo(a);return n.append("<h3>Not found</h3>"),n.append("<p>If a TVK cannot be found by the NBN web service used for this checking, then you can double-check by going directly to the NBN Atlas page and searching on the TVK (https://nbnatlas.org/). To resolve problems with TVKs not being recognised, you may have to contact the NBN or the NHM who look after the UKSI.</p>"),i.append("<h3>Found</h3>"),o.text("Checking TVKs..."),t.f.tvkCheck(function(t){e("#tombioTvkFound").append(e("<p>").html("TVK '"+t.tvk+"' found."))},function(t){e("#tombioTvkNotFound").append(e("<p>").html("TVK '"+t.tvk+"' for '"+t.taxon+"' cannot be found."))},function(){o.text("Completed checking TVKs")}),a},t.f.getTaxonCharacterValues=function(a){var o=e("<table>");o.css("width","100%"),o.css("margin","0px");var n=0,i="";return t.d.characters.forEach(function(r){if("key"==r.Status||"display"==r.Status){if(t.d.oCharacters.grouped&&r.Group!=i){(l=e("<tr>")).css("background-color","rgb(100,100,100)"),l.css("color","rgb(255,255,255)");var s=e("<td colspan='3'>");l.append(s.append(r.Group)),o.append(l),i=r.Group}n++;var l=e("<tr>");n%2!=0?l.css("background-color","rgb(200,200,200)"):l.css("background-color","rgb(230,230,230)");var c=e("<td>").append(r.Label),u=e("<td>").append(a[r.Character].toHtml1());l.append(c),l.append(u),o.append(l)}}),o.find("td").css("padding","2"),o},t.f.addTaxonImagesToContainer=function(a){var o=a.taxon,n=a.container,i=a.indexSelected?a.indexSelected:0,r=!!a.imageRemovalButton&&a.imageRemovalButton,s=a.fImageSelect?a.fImageSelect:null,l=a.height?a.height:400,c=t.f.getTaxonImages(o);if(0!=c.length){var u=e("<div>").addClass("tombio-galleria-pane").css("position","relative").css("max-width","2000px").css("height",l).appendTo(n),d=[];c.forEach(function(e){var t={image:e.URI,thumb:e.SmallURI?e.SmallURI:null,big:e.LargeURI?e.LargeURI:null,alt:e.Caption,title:e.Caption};d.push(t)}),Galleria.run(u,{transition:"fade",wait:!0,dataSource:d,theme:"classic",show:i}),u.data("galleria").bind("loadfinish",function(e){s&&s(e.index)}),e("<img>").attr("src",t.opts.tombiopath+"resources/enlarge.png").appendTo(u).addClass("tombio-galleria-lightbox-button").on("click",function(){u.data("galleria").openLightbox()}),r&&e("<img>").attr("src",t.opts.tombiopath+"resources/remove.png").appendTo(u).addClass("tombio-galleria-remove-button").on("click",function(){u.data("galleria").destroy(),n.addClass("userRemoved"),n.remove()})}else{e("<div>").css("margin","10px").text("No images are specified in the knowledge-base for this taxon.").appendTo(n)}},t.f.getTaxonImages=function(e){return t.d.media.filter(function(t){if(t.Taxon==e&&("image-local"==t.Type||"image-web"==t.Type))return!0}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)})},t.f.getCharacterImages=function(e,a,o){return t.d.media.filter(function(t){if(t.Character==e&&("image-local"==t.Type||"image-web"==t.Type)&&!(a&&t.State!=a||o&&t.UseFor&&!(t.UseFor.split(",").indexOf(o)>-1)))return!0}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)})},t.f.addNBNMapToContainer=function(a,o){a=a+="";var n=e("<div>").appendTo(o).css("border","1px solid black").css("padding","5px").css("border-radius","10px"),i=e("<img>").addClass("tombioNbnLogo").attr("src",t.opts.tombiopath+"/resources/nbn-logo-centred.png").addClass(function(){if(a)return"tombioSpiningNbn"}()).appendTo(n),r=e("<div>").addClass("tombioNbnLoading").css("font-size","0.8em").text(a?"Loading distribution map from NBN...":"No TVK specified for this taxon").appendTo(n);if(a)if(t.d.nbnMapCache[a]){var s=t.d.nbnMapCache[a];i.attr("src",t.opts.tombiopath+"/resources/nbn-logo-colour-centred.png").removeClass("tombioSpiningNbn"),r.hide()}else{var l="https://records-ws.nbnatlas.org/mapping/wms/image?baselayer=world&format=jpg&pcolour=3531FF&scale=on&popacity=1&q=*:*&fq=lsid:"+a+"&extents=-11.2538,48.6754,3.0270,60.7995&outline=false&outlineColour=0x000000&pradiusmm=1&dpi=200&widthmm=100";s=e("<img>").attr("id","tombioNbnMapImage").on("load",function(){i.attr("src",t.opts.tombiopath+"/resources/nbn-logo-colour-centred.png").removeClass("tombioSpiningNbn"),r.hide()}).on("error",function(){i.removeClass("tombioSpiningNbn"),r.text("An error was encountered attemping to retrieve an NBN distribution map for the TVK "+a),s.hide()}).attr("src",l);t.d.nbnMapCache[a]=s}e("<div>").append(s).appendTo(n)},t.f.addTaxonHtmlToContainer=function(a,o,n){var i=t.f.getTaxonHtmlFiles(a);n<=i.length-1?e.get(i[n].URI,function(t){var a=t.indexOf("<body"),n=t.indexOf("</body"),i=t.slice(a,n),r=e("<div>").html(i);o.html(r.html())}):o.html(null)},t.f.getTaxonHtmlFiles=function(e){return t.d.media.filter(function(t){if(t.Taxon==e&&"html-local"==t.Type)return!0}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)})},t.f.getCharacterScoreDetails=function(e,a){var o;return o="<p>Specified state(s) for character <b>"+a.Label+"</b>: </p>",o+="<ul>","numeric"!=a.ValueType?t.d.oCharacters[a.Character].userInput.forEach(function(e){o+="<li><b>",o+=t.d.oCharacters[a.Character].CharacterStateValues[e],o+="</b></li>"}):(o+="<li><b>",o+=t.d.oCharacters[a.Character].userInput,o+="</b></li>"),o+="</ul>",o+="<p>Valid state(s) for <b>"+a.Label+"</b> recorded against ",o+="<b><i>"+e.taxon+"</i></b> in the knowledge base: ",o+="<ul>",o+=e[a.Character].toHtml2(),o+="</ul>",o+="<hr/>",o+="<p>Knowledge-base <b>weighting</b> for this character: <b>"+a.Weight+"</b></p>",o+="<p>Knowledge-base <b>latitude</b> for this character: <b>"+a.Latitude+"</b></p>",o+="<hr/>",o+="<p>Unweighted character score: <b>"+Math.round(100*e[a.Character].score.overall)/100+"</b>; ",o+="(for, "+Math.round(100*e[a.Character].score.for)/100,o+="; against, "+Math.round(100*(e[a.Character].score.against+e[a.Character].score.na))/100+")</p>",o+="<p>Weighted character score: <b>"+Math.round(e[a.Character].score.overall*a.Weight*10)/100+"</b></p>"},t.f.sortTaxa=function(e,t){return t||(t="all"),e.sort(function(e,a){if("matched"==t){if(e.visState.score.charFor>a.visState.score.charFor)return-1;if(a.visState.score.charFor>e.visState.score.charFor)return 1}return e.visState.score.overall>a.visState.score.overall?-1:a.visState.score.overall>e.visState.score.overall?1:a.visState.score.overall==e.visState.score.overall?e.visState.score.for>a.visState.score.for?1:a.visState.score.for>e.visState.score.for?-1:e.kbPosition>a.kbPosition?1:-1:void 0})},t.f.getTaxonTipImage=function(a,o){var n=t.d.media.filter(function(e){if(e.Taxon==a&&("image-local"==e.Type||"image-web"==e.Type)){if(e.UseFor){var t=!1;return e.UseFor.split(",").forEach(function(e){"tip"==e.toLowerCase().trim()&&(t=!0)}),t}return!0}}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)});if(n.length>0){var i=e("<div/>"),r=n[0],s=e("<img/>",{src:r.URI}).appendTo(i).css("margin-top",2);e("<figcaption/>",{html:r.Caption}).appendTo(i);return r.ImageWidth&&s.css("width",r.ImageWidth),i}return null},t.f.taxonTag=function(e){return e.replace(/[\/|&;$%@"<>()+:.,' ]/g,"")},t.f.copyTextToClipboard=function(e){var t=document.createElement("textarea");t.value=e,document.body.appendChild(t),t.select();try{var a=document.execCommand("copy")?"successful":"unsuccessful";console.log("Copying text "+a)}catch(e){console.log("Oops, unable to copy text")}document.body.removeChild(t)},t.f.createViewURL=function(e){var a=window.location.href.split("tbv=")[0],o=-1==a.indexOf("?")?"?":"&",n=encodeURI(a+o+"tbv=&"+e.join("&"));t.f.copyTextToClipboard(n)},t.f.selectElementText=function(e,t){var a,o,n=(t=t||window).document;t.getSelection&&n.createRange?(a=t.getSelection(),(o=n.createRange()).selectNodeContents(e),a.removeAllRanges(),a.addRange(o)):n.body.createTextRange&&((o=n.body.createTextRange()).moveToElementText(e),o.select())},t.f.checkInterface=function(e,a,o){t.opts.devel&&function t(a,o,n){for(var i in o)o.hasOwnProperty(i)&&(n[i]?"object"==typeof o[i]&&t(a+"."+i,o[i],n[i]):console.log("%cInterface warning: "+e+a+"."+i+" not found in "+e,"color: red"))}("",a,o)},t.f.stateValueHelpPresent=function(e){for(var a=0;a<t.d.values.length;a++){var o=t.d.values[a];if(o.Character==e&&o.StateHelp)return!0}return!1},t.f.getFullCharacterHelp=function(a){var o=e("<div>");return e("<p>").html(t.d.oCharacters[a].Help).appendTo(o),t.d.media.filter(function(e){if(("image-local"==e.Type||"image-web"==e.Type)&&e.Character==a&&!e.State){if(e.UseFor){var t=!1;return e.UseFor.split(",").forEach(function(e){"full"==e.toLowerCase().trim()&&(t=!0)}),t}return!0}}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)}).forEach(function(t,a){var n=e("<figure/>").appendTo(o);n.addClass("helpFigure");var i=e("<img/>",{src:t.URI}),r=e("<figcaption/>",{html:t.Caption});n.append(i).append(r),a>0&&i.css("margin-top",10),r.appendTo(o),t.ImageWidth&&i.css("width",t.ImageWidth)}),t.d.values.filter(function(e){if(e.Character==a)return!0}).forEach(function(n){if(n.CharacterStateTranslation&&""!=n.CharacterStateTranslation)var i=n.CharacterStateTranslation;else i=n.CharacterState;n.StateHelp&&(i+=": ");var r=e("<p/>").appendTo(o),s=e("<span/>",{text:i}).css("font-weight","Bold");r.append(s);var l=e("<span/>",{html:n.StateHelp}).css("font-weight","Normal");r.append(l),t.d.media.filter(function(e){if(("image-local"==e.Type||"image-web"==e.Type)&&e.Character==a&&e.State==n.CharacterState)return!0}).sort(function(e,t){return Number(e.Priority)-Number(t.Priority)}).forEach(function(t,a){var n=e("<div>").appendTo(o);n.css("background-color","rgb(220,220,220)"),n.css("border-radius","5px"),n.css("padding","5px"),n.css("margin-bottom","10px");var i=e("<img/>",{src:t.URI}),r=e("<figcaption/>",{html:t.Caption});i.appendTo(n),r.appendTo(n),t.ImageWidth&&i.css("width",t.ImageWidth)})}),o.html()}}(jQuery,this.tombiovis);