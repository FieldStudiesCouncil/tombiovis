!function(i,e){"use strict";function t(){for(var i in e.gui.main.contextMenu.items){var t=!0;-1==e.gui.main.contextMenu.visContexts[i].indexOf(e.v.currentTool)&&(t=!1),e.gui.main.contextMenu.guiContexts[i]&&-1==e.gui.main.contextMenu.guiContexts[i].indexOf(e.opts.gui)&&(t=!1),t?e.gui.main.contextMenu.items[i].show():e.gui.main.contextMenu.items[i].hide()}}e.gui.main={},e.gui.main.contextMenu={items:{},visContexts:{},guiContexts:{}},e.gui.main.contextMenu.addItem=function(o,a,n,s,r){if(n&&o in e.gui.main.contextMenu.items&&(e.gui.main.contextMenu.items[o].remove(),delete e.gui.main.contextMenu.items[o],delete e.gui.main.contextMenu.visContexts[o],delete e.gui.main.contextMenu.guiContexts[o]),!(o in e.gui.main.contextMenu.items)){var u=i("<li>").append(i("<div>").text(o).click(a));e.gui.main.contextMenu.menu.append(u),e.gui.main.contextMenu.menu.menu("refresh"),e.gui.main.contextMenu.items[o]=u,e.gui.main.contextMenu.visContexts[o]=s,e.gui.main.contextMenu.guiContexts[o]=r}t()},e.gui.main.contextMenu.removeItem=function(i){i in e.gui.main.contextMenu.items&&(e.gui.main.contextMenu.items[i].remove(),delete e.gui.main.contextMenu.items[i],delete e.gui.main.contextMenu.visContexts[i],delete e.gui.main.contextMenu.guiContexts[i])},e.gui.main.updateProgress=function(e){100==e&&i("#tombioGuiLargeDownloadProgressHeader").text("Resource download complete"),i("#tombioGuiLargeDownloadProgress").progressbar("value",e)},e.gui.main.offlineOptions=function(){i("#offlineOptions").html('<button id="tombioGuiLargeOfflineButton">Download for offline use</button><p id="tombioGuiLargeDownloadProgressHeader" style="display: none">Downloading resources...</p><div id="tombioGuiLargeDownloadProgress" style="display: none;"></div><p></p>'),i("#tombioGuiLargeOfflineButton").button().click(function(){i("#tombioGuiLargeDownloadProgressHeader").show(),i("#tombioGuiLargeDownloadProgress").show(),e.f.cacheAll()}),i("#tombioGuiLargeDownloadProgress").progressbar({min:0,max:100,value:0}),e.gui.main.visShow("offlineOptions")},e.gui.main.offerRefresh=function(){i("#tombioGuiDialog").remove(),i("<div>").attr("id","tombioGuiDialog").css("display","none").appendTo(i("#tombioGuiLargeJqueryUi")),i("#tombioGuiDialog").dialog({resizable:!1,height:"auto",width:400,modal:!0,buttons:{Refresh:function(){window.location.reload()},"Not now":function(){i(this).dialog("close")}}}),i("#tombioGuiDialog").dialog("option","title","Refresh required"),i("#tombioGuiDialog").html("<p>To complete preparation for using offline, a refresh is required.</p>"),i("#tombioGuiDialog").dialog("open")},e.gui.main.setSelectedTool=function(e){i("#tombioGuiLargeJqueryUiVisualisation").val()!=e&&i("#tombioGuiLargeJqueryUiVisualisation").val(e)},e.gui.main.resizeControlsAndTaxa=function(){if(i("#tombioGuiLargeJqueryUiControls").is(":visible")){var e=i("#tombioGuiLargeJqueryUiControls").width();i("#tombioGuiLargeJqueryUiTaxa").css("margin-left",e+10);var t=i("#tombioGuiLargeJqueryUiControls").height();i("#tombioGuiLargeJqueryUiControlsAndTaxa").css("min-height",t+10)}else i("#tombioGuiLargeJqueryUiTaxa").css("margin-left",0),i("#tombioGuiLargeJqueryUiControlsAndTaxa").css("min-height","0px")},e.gui.main.init=function(){i("#tombiod3vis").html(""),i("#tombiod3vis").css("position","relative"),i("<div>").attr("id","tombioGuiLargeJqueryUi").addClass("needsclick").css("display","none").appendTo("#tombiod3vis"),i("<div style='width: "+window.screen.width+"px'>").attr("id","tombioGuiLargeJqueryUiDeviceWarning").appendTo("#tombioGuiLargeJqueryUi"),i("<div>").attr("id","tombioGuiLargeJqueryUiDeviceWarningInnerDiv").css("margin","2em").appendTo(i("#tombioGuiLargeJqueryUiDeviceWarning")),i("<p>").text("This Identikit tool is designed for large format devices. If you are working with a small screen or with a touch device, it might not appear or work as intended. We are working to produce a range of 'mobile-first' tools in the latter part of 2018.").appendTo(i("#tombioGuiLargeJqueryUiDeviceWarningInnerDiv")),i("<img>").attr("id","tombioGuiLargeJqueryUiDeviceWarningButton").attr("src",e.opts.tombiopath+"/resources/remove.png").css("position","absolute").css("right","10px").css("top","10px").appendTo(i("#tombioGuiLargeJqueryUiDeviceWarningInnerDiv")),i("#tombioGuiLargeJqueryUiDeviceWarningButton").on("click",function(){i("#tombioGuiLargeJqueryUiDeviceWarning").hide()}),i("<div>").attr("id","tombioGuiLargeJqueryUiFlashDisplay").css("display","none").appendTo("#tombioGuiLargeJqueryUi");var t=i("<table>").appendTo("#tombioGuiLargeJqueryUi"),o=i("<tr>").appendTo(t),a=i("<td>").appendTo(o),n=i("<td>").appendTo(o);i("<select>").attr("id","tombioGuiLargeJqueryUiVisualisation").appendTo(a),i.ajax({type:"HEAD",url:e.opts.tombiokbpath+"info.pdf",success:function(t){var o=i("<img>").attr("src",e.opts.tombiopath+"resources/pdf.png");o.css("height","25px"),o.css("position","relative"),o.css("top","-3px");var a=i("<a>").attr("href",e.opts.tombiokbpath+"info.pdf");a.append(o),n.append(a)}}),i("<div>").addClass("tombioNoSelect").attr("id","tombioGuiLargeJqueryUiControlsAndTaxa").appendTo("#tombioGuiLargeJqueryUi"),i("<div>").attr("id","tombioGuiLargeJqueryUiControls").appendTo("#tombioGuiLargeJqueryUiControlsAndTaxa"),i("<div>").attr("id","tombioGuiLargeJqueryUiTaxa").appendTo("#tombioGuiLargeJqueryUiControlsAndTaxa"),i("<div>").attr("id","currentVisInfo").css("display","none").appendTo("#tombioGuiLargeJqueryUi"),i("<div>").attr("id","kbInfo").css("display","none").appendTo("#tombioGuiLargeJqueryUi"),i("<div>").attr("id","visInfo").css("display","none").appendTo("#tombioGuiLargeJqueryUi"),i("<div>").attr("id","tombioCitation").css("display","none").appendTo("#tombioGuiLargeJqueryUi"),i("<div>").attr("id","mediaFilesCheck").css("display","none").appendTo("#tombioGuiLargeJqueryUi"),i("<div>").attr("id","tvkCheck").css("display","none").appendTo("#tombioGuiLargeJqueryUi"),i("<div>").attr("id","offlineOptions").css("display","none").appendTo("#tombioGuiLargeJqueryUi"),e.gui.main.divVis="#tombioGuiLargeJqueryUiTaxa",e.gui.main.divInput="#tombioGuiLargeJqueryUiControls",e.f.checkInterface("guiLargeJqueryUi",e.templates.gui.main,e.gui.main)},e.gui.main.createUIControls=function(){i("#tombioGuiLargeJqueryUi").css("display",""),e.gui.main.contextMenu.menu=i("<ul>").css("white-space","nowrap").appendTo("#tombioGuiLargeJqueryUi").addClass("contextMenu").css("position","absolute").css("display","none").css("z-index",999999),e.gui.main.contextMenu.menu.menu(),i("#tombioGuiLargeJqueryUi").on("contextmenu",function(t){e.gui.main.contextMenu.menu.position({});var o=i(this).parent().offset(),a=t.pageX-o.left,n=t.pageY-o.top;return e.gui.main.contextMenu.menu.css({left:a,top:n}),e.gui.main.contextMenu.menu.show(),!1}),i("#tombioGuiLargeJqueryUi").on("click",function(){e.gui.main.contextMenu.menu.hide()});var t=[];e.opts.devel&&t.push(i('<option value="reloadkb" class="html" data-class="wrench">Reload KB</option>')),e.opts.checkKB&&(t.push(i('<option value="mediaFilesCheck" class="html" data-class="wrench">Check media files</option>')),e.d.oCharacters.tvk&&t.push(i('<option value="tvkCheck" class="html" data-class="wrench">Check TVKs</option>'))),e.v.includedVisualisations.forEach(function(o,a){var n=i('<option class="needsclick">').attr("value",o).attr("data-class","vis").addClass("visualisation").text(e.js.jsFiles[o].toolName);t.push(n)}),t.push(i('<option id="optCurrentVisInfo" value="currentVisInfo" class="html" data-class="info"></option>')),t.push(i('<option value="kbInfo" class="html" data-class="info">About the Knowledge-base</option>')),t.push(i('<option value="visInfo" class="html" data-class="info">About FSC Identikit</option>')),t.push(i('<option value="tombioCitation" class="html" data-class="info">Get citation text</option>')),t.forEach(function(i){i.attr("value")==e.v.selectedTool&&i.attr("selected","selected")}),e.opts.pwa&&t.push(i('<option value="offline" class="html" data-class="download">Offline options</option>')),t.push(i('<option value="reload" class="html" data-class="reload">Reload app</option>')),i("#tombioGuiLargeJqueryUiVisualisation").append(t),i.widget("custom.iconselectmenu",i.ui.selectmenu,{_renderItem:function(e,t){var o=i("<li>"),a=i("<div>",{text:t.label});return t.disabled&&o.addClass("ui-state-disabled"),i("<span>",{style:t.element.attr("data-style"),class:"ui-icon "+t.element.attr("data-class")}).appendTo(a),o.append(a).appendTo(e)}}),i("#tombioGuiLargeJqueryUiVisualisation").iconselectmenu({change:function(){e.f.visChanged(i("#tombioGuiLargeJqueryUiVisualisation").val())}}).iconselectmenu("menuWidget").addClass("ui-menu-icons customicons"),1==e.opts.hideVisDropdown&&i("#tombioGuiLargeJqueryUiVisualisation-button").hide()},e.gui.main.visShow=function(o){if("tombioCitation"==o&&i("#tombioCitation").html(e.f.createCitationPage()),"mediaFilesCheck"==o&&i("#mediaFilesCheck").html(e.f.createMediaCheckPage()),"tvkCheck"==o&&i("#tvkCheck").html(e.f.createTvkCheckPage()),"kbInfo"==o&&0==i("#kbInfo").html().length&&e.f.setKbInfo(i("#kbInfo")),"visInfo"==o&&0==i("#visInfo").html().length&&e.f.setVisInfo(i("#visInfo")),"currentVisInfo"==o&&(i("#currentVisInfo").html(""),e.f.setSelectedToolInfo(i("#currentVisInfo"))),console.log("selectedToolName",o),o!=e.v.currentTool&&(e.v.currentTool&&(e.v.visualisations[e.v.currentTool]?e.v.visualisations[e.v.currentTool].hide():i("#"+e.v.currentTool).hide()),e.v.visualisations[o]?e.v.visualisations[o].show():i("#"+o).show()),e.v.visualisations[o]?i("#tombioGuiLargeJqueryUiControlsAndTaxa").show():i("#tombioGuiLargeJqueryUiControlsAndTaxa").hide(),e.f.refreshVisualisation(),e.v.currentTool=o,Object.keys(e.v.visualisations).indexOf(o)>-1&&(e.v.lastVis=o,i("#optCurrentVisInfo").text("Using the "+e.v.visualisations[e.v.lastVis].metadata.title),i("#tombioGuiLargeJqueryUiVisualisation").iconselectmenu("refresh")),t(),!e.v.initialised&&e.v.visualisations[o]){for(var a={},n=decodeURI(window.location.search.substring(1)).replace(/\+/g," ").split("&"),s=0;s<n.length;s++){var r=n[s].split("=");a[r[0]]=r[1]}e.v.visualisations[o].urlParams(a),e.v.initialised=!0}},e.gui.main.dialog=function(e,t){i("#tombioGuiDialog").remove(),i("<div>").attr("id","tombioGuiDialog").css("display","none").appendTo(i("#tombioGuiLargeJqueryUi")),i("#tombioGuiDialog").dialog({modal:!1,width:550,height:450,resizable:!0,draggable:!0,autoOpen:!1,show:{effect:"highlight",duration:500},hide:{effect:"fade",duration:250}}),i("#tombioGuiDialog").dialog("option","title",e),i("#tombioGuiDialog").html(t),i("#tombioGuiDialog").dialog("open")},e.gui.main.createCharacterTooltips=function(t){i(t).tooltip({track:!0,items:"span",content:function(){return function(t){var o=i("<div/>"),a=!1;if(e.d.oCharacters[t].HelpShort&&""!=e.d.oCharacters[t].HelpShort){var n=e.d.oCharacters[t].HelpShort;a=!0}else var n=e.d.oCharacters[t].Help;var s,r,u=e.d.media.filter(function(i){if(("image-local"==i.Type||"image-web"==i.Type)&&i.Character==t)return!0}).sort(function(i,e){return Number(i.Priority)-Number(e.Priority)}),l=0,d=0;u.forEach(function(i){var e=!1,t=!1;i.UseFor?i.UseFor.split(",").forEach(function(o){"tip"==o.toLowerCase().trim()&&(t=!i.State),"full"==o.toLowerCase().trim()&&(e=!0)}):(t=!i.State,e=!0),t&&!s?s=i:e&&l++,e&&d++});var c=!1;if(s){(r=i("<figure/>")).addClass("keyInputHelpFigure");var p=i("<img/>",{src:s.URI}).appendTo(r).css("margin-top",2);s.ImageWidth&&p.css("width",s.ImageWidth);i("<figcaption/>",{html:s.Caption}).appendTo(r);if(s.TipStyle&&""!=s.TipStyle){var m=s.TipStyle.split("-"),g=m[0],f=m[1];r.css("width",f+"%"),r.css("float",g),r.css("margin-bottom",5),"right"==g?r.css("margin-left",5):r.css("margin-right",5),c=!0}}var h=[];c&&h.push(r);n.length>0&&h.push(i("<span/>").html(n));!c&&r&&h.push(r);h.forEach(function(i){o.append(i)});var v=e.f.stateValueHelpPresent(e.d.oCharacters[t]),b="";if(a||l>0||v.length>0)var b="(Click for <b>more detailed help</b>.)";else if(s&&d>0)var b="(Click for resizeable help window.)";b&&i("<div/>").css("margin-top",5).css("font-weight","normal").html(b).appendTo(o);return o}(i(this).attr("character"))}})},e.gui.main.createTaxonToolTips=function(t,o){i(t).tooltip({track:!0,items:"text",content:function(){if(o)return e.f.getTaxonTipImage(this.textContent,this)},open:function(e,t){var o=i(e.target);t.tooltip.click(function(){o.tooltip("close")})}})},e.gui.main.tooltip=function(e){i(e).tooltip()},e.gui.main.showFullDetails=function(t,o,a,n){var s;a=void 0!==a?a:0,n=void 0!==n?n:0,o=void 0!==o?o:1;var r=i("<div>").addClass("tombioFullDetailsTabs");r.css("border","none");var u=i("<ul>").appendTo(r);u.append("<li><a href='#tabs-1'>Knowledge-base</a></li>"),u.append("<li><a href='#tabs-2'>Images</a></li>"),e.d.oCharacters.tvk&&u.append("<li><a href='#tabs-4'>NBN map</a></li>"),u.append("<li><a href='#tabs-3'>Details</a></li>");var l=i("<div>").attr("id","tabs-1").appendTo(r),d=i("<div>").attr("id","tabs-2").appendTo(r);if(e.d.oCharacters.tvk)var c=i("<div>").attr("id","tabs-4").appendTo(r);var p=i("<div>").attr("id","tabs-3").appendTo(r),m=i("<div>").append(r);m.attr("title",t),m.dialog({closeText:"",height:550,width:600,modal:!0,resizeStop:function(i,e){r.tabs("refresh"),h()}}),r.tabs({heightStyle:"fill",active:o,create:function(){s=m.height()-l.height()},activate:function(i,e){r.tabs("refresh"),1==e.newTab.index()&&h()}}),p.css("overflow","hidden");var g=e.f.getTaxonCharacterValues(e.d.oTaxa[t]);l.append(g);e.f.addTaxonImagesToContainer({taxon:t,container:d,height:d.height()});if(e.d.oCharacters.tvk&&e.d.oTaxa[t].tvk){var f=i("<div>").css("position","relative").appendTo(c);e.f.addNBNMapToContainer(e.d.oTaxa[t].tvk,f)}function h(){var i=m.find(".tombio-galleria-pane").first();i.data("galleria")&&(i.data("galleria").setOptions("height",m.height()-s),i.data("galleria").resize())}!function(t,o){var a=i("<div>").appendTo(o),n=e.f.getTaxonHtmlFiles(t);if(0==n.length){var s=i("<div>").css("margin","10px").appendTo(a);s.text("No text information files (HTML) are specified in the knowledge-base for this taxon.")}else{var r=i("<div>");if(n.length>1){var u=i('<div style="margin-bottom: 20px">').appendTo(a),l=i("<select id='tombioFileSelect'></select>").appendTo(u);n.forEach(function(e,t){var o=i("<option/>").text(e.Caption).attr("value",t);l.append(o)}),l.selectmenu({change:function(i,o){e.f.addTaxonHtmlToContainer(t,r,o.item.value)}})}r.appendTo(a),e.f.addTaxonHtmlToContainer(t,r,0)}}(t,p)}}(jQuery,this.tombiovis);