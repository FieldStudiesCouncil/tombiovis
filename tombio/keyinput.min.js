(function(n,t){"use strict";t.keyInput={bullet:"",inputCharGroups:[],helpAndInfoDialogWidth:550,helpAndInfoDialogHeight:400,verticalTabSpace:33};t.keyInput.init=function(i){var f=this,e,ht,c,u,o,p,v,l,h,a,et,ot,g,st,nt;n("<div>").attr("id","tombioKeyInputDialog").css("display","none").appendTo(i);n("#tombioKeyInputDialog").dialog({modal:!1,width:this.helpAndInfoDialogWidth,height:this.helpAndInfoDialogHeight,resizable:!0,draggable:!0,autoOpen:!1,show:{effect:"highlight",duration:500},hide:{effect:"fade",duration:250}});n("<div>").attr("id","tombioKeyInputTabs").css("background-color","rgba( 255,255, 255, 0.7)").appendTo(i);n("<ul>").attr("id","tombioKeyInputListElements").appendTo("#tombioKeyInputTabs");t.keyInput.$div=n("#tombioKeyInputTabs");e={All:[]};ht={};t.characters.forEach(function(n){n.Status=="key"&&(e[n.Group]||(e[n.Group]=[],f.inputCharGroups.push(n.Group)),e[n.Group].push(n))});n("#tombioControls").css("min-height",this.verticalTabSpace*(this.inputCharGroups.length+2));for(c in e){var y="tombioKeyInputTab-"+c.replace(/\s+/g,"-"),tt=n("<li/>"),ct=n("<a/>").text(c).attr("href","#"+y);if(tt.append(ct),n("#tombioKeyInputListElements").append(tt),u=n("<div/>").attr("id",y),n("#tombioKeyInputTabs").append(u),y=="tombioKeyInputTab-All"){u.append(n("<div>").text("Un-used characters:").css("font-weight","bold"));o=n("<fieldset>").attr("id","visCheckboxes").css("display","inline-block").css("padding","0px").css("border","none");o.append(n("<label>").attr("for","charvisible").text("show"));o.append(n("<input>").attr("type","radio").attr("name","charvisibility").attr("id","charvisible").attr("value","visible").attr("checked","checked"));o.append(n("<label>").attr("for","incharvisible").text("hide"));o.append(n("<input>").attr("type","radio").attr("name","charvisibility").attr("id","incharvisible").attr("value","invisible"));u.append(o);n("[name='charvisibility']").checkboxradio({icon:!1});o.on("change",f.setCloneVisibility);p=n("<button>").attr("id","tombioReset").text("Reset all");p.button({icons:{primary:null,secondary:"ui-icon-reset"}}).click(function(){n(".statespinner").spinner("value","");n(".stateselect").each(function(){n(this).val()&&n(this).val("").pqSelect("refreshData")});t.characters.forEach(function(n){n.stateSet=!1;n.userInput=null});t.refreshVisualisation();f.setCloneVisibility()});u.append(p)}for(v=0;v<e[c].length;v++){var r=e[c][v],w=n("<span/>").attr("class","characterlabel").text(r.Label),it=n("<div/>").append(w);if(u.append(it),t.characterHasHelp(r.Character)&&(w.attr("character",r.Character),w.addClass("characterhelp")),l=n("<div/>").attr("class","cloneInput"),l.append(it.clone()),n("#tombioKeyInputTab-All").append(l),r.ValueType=="numeric"){var s=r.Character,b=r.Params.split(","),rt=Number(b[0]),ut=Number(b[1]),ft=Number(b[2]),k=n("<div><\/div>"),lt=n("<input><\/input>").attr("class","spinner").attr("id",s),at=n("<div value='x'>").attr("class","widget").attr("class","spinclear").attr("id",s+"-clear");k.append(lt);k.append(at);u.append(k);this.makeSpinner(s,rt,ut,ft);var d=n("<div><\/div>"),vt=n("<input><\/input>").attr("class","spinner").attr("id","clone-"+s),yt=n("<div value='x'>").attr("class","widget").attr("class","spinclear").attr("id","clone-"+s+"-clear");d.append(vt);d.append(yt);l.append(d);this.makeSpinner("clone-"+s,rt,ut,ft)}else h=r.Character,a=r.ControlType=="multi"?n("<select multiple=multiple><\/select>").attr("class","characterSelect"):n("<select><\/select>").attr("class","characterSelect"),a.attr("id",h),u.append(a),r.ControlType=="single"&&(et=n("<option/>").text(""),a.append(et)),ot=r.CharacterStateValues,ot.forEach(function(t){var i=n("<option/>").text(f.bullet+t);a.append(i)}),this.makeSelect(h),g=n("#"+h).clone(),g.attr("id","clone-"+h),l.append(g),this.makeSelect("clone-"+h)}}t.oCharacters.grouped||(n("#tombioKeyInputListElements").css("display","none"),n("#tombioKeyInputTabs").css("padding-left","0px"));st=n("#tombioKeyInputTabs").tabs({activate:function(){n(".stateselect").each(function(){});t.resizeControlsAndTaxa()}});t.opts||(t.opts={});t.opts.toolconfig||(t.opts.toolconfig={});t.opts.toolconfig.keyinput||(t.opts.toolconfig.keyinput={});typeof t.opts.toolconfig.keyinput.selectedGroup=="undefined"&&(t.opts.toolconfig.keyinput.selectedGroup=typeof t.opts.selectedGroup=="undefined"?t.kbconfig.defaultControlGroup?t.kbconfig.defaultControlGroup:null:t.opts.selectedGroup?t.opts.selectedGroup:null);t.opts.toolconfig.keyinput.selectedGroup&&(nt=f.inputCharGroups.indexOf(t.opts.toolconfig.keyinput.selectedGroup),nt>-1&&st.tabs("option","active",nt+1));n(".characterhelp").hover(function(){n(this).animate({color:"#D55E00"},"fast")},function(){n(this).animate({color:"black"},"fast")}).tooltip({track:!0,items:"span",content:function(){return f.getCharacterToolTip(n(this).attr("character"))}}).click(function(){f.showCharacterHelp(n(this).attr("character"))})};t.keyInput.initFromCharacterState=function(){t.characters.forEach(function(t){var i,r,u;if(t.ControlType==="spin"){var i=n("#"+t.Character+".statespinner"),r=n("#clone-"+t.Character+".statespinner"),f=t.stateSet?t.userInput:"";i.spinner("value",t.userInput);r.spinner("value",f)}else i=n("#"+t.Character+".stateselect"),r=n("#clone-"+t.Character+".stateselect"),u=t.stateSet?t.userInput.map(function(n){return t.CharacterStateValues[n]}):[],i.val(u).pqSelect("refreshData"),r.val(u).pqSelect("refreshData")})};t.keyInput.initStateFromParams=function(t){this.initFromCharacterState();n("#tombioKeyInputTabs").tabs("option","active",t.grp);n("[name='charvisibility']").removeProp("checked").filter('[value="'+t.cvis+'"]').prop("checked",!0);n("[name='charvisibility']").checkboxradio("refresh");this.setCloneVisibility()};t.keyInput.setParamsFromState=function(t){return t.push("grp="+n("#tombioKeyInputTabs").tabs("option","active")),t.push("cvis="+n("input[name=charvisibility]:checked").val()),t};t.keyInput.otherState={keys:[]};t.keyInput.setCloneVisibility=function(){var i=n("input[name=charvisibility]:checked").val();n(".cloneInput .stateselect, .cloneInput .statespinner").each(function(){var u=n(this).attr("id"),r;typeof u!="undefined"&&(i=="visible"?n(this).parents(".cloneInput").show(500,t.resizeControlsAndTaxa):(r=n(this).val(),r&&r!=""?n(this).parents(".cloneInput").show(500,t.resizeControlsAndTaxa):n(this).parents(".cloneInput").hide(500,t.resizeControlsAndTaxa)))})};t.keyInput.makeSelect=function(i){var u=this,r=n("#"+i).pqSelect({multiplePlaceholder:"select option(s)",singlePlaceholder:"select option",checkbox:!0,search:!1,maxDisplay:20,width:240,selectallText:""});r.addClass("stateselect");r.on("change",function(){var e,f,o,h,s;e=i.substring(0,6)=="clone-"?i.substring(6):"clone-"+i;n("#"+e).val(r.val());n("#"+e).pqSelect("refreshData");n("#"+i).pqSelect("refresh");u.setCloneVisibility();f=i.substring(0,6)=="clone-"?i.substring(6):i;o=r.val()!=null&&r.val()!="";t.oCharacters[f].stateSet=o;o?(h=typeof r.val()=="string"?[r.val()]:r.val(),s=[],t.d.oCharacters[f].CharacterStateValues.forEach(function(n,t){h.indexOf(n)>-1&&s.push(t)}),t.d.oCharacters[f].userInput=s):t.d.oCharacters[f].userInput=null;[i,e].forEach(function(i){var r=n("#"+i).next().children().find(".pq-select-item-text");r.attr("title",function(){var r=this,i=t.values.filter(function(t){if(t.Character==f&&t.CharacterState==n(r).text())return!0});return i.length==1?i[0].StateHelpShort?i[0].StateHelpShort:i[0].StateHelp:""});r.tooltip({track:!0})});t.refreshVisualisation()});r.val(n("#"+i+" option:first").val()).pqSelect("refreshData");r.val("").pqSelect("refreshData")};t.keyInput.makeSpinner=function(i,r,u,f){var s=this,e=n("#"+i).spinner({min:r,max:u,step:f}),o;e.addClass("statespinner");e.on("spinstop",function(){var r=e.spinner("value"),o,u,f;i.substring(0,6)=="clone-"?(o=!0,u=i.substring(6)):(o=!1,u="clone-"+i);n("#"+u).spinner("value",r);f=i.substring(0,6)=="clone-"?i.substring(6):i;t.oCharacters[f].stateSet=!0;t.oCharacters[f].userInput=r;console.log(r);t.refreshVisualisation();s.setCloneVisibility()});o=n("#"+i+"-clear").button({icon:"ui-icon-close",showLabel:!1});o.on("click",function(){var f,r,u;e.spinner("value","");i.substring(0,6)=="clone-"?(f=!0,r=i.substring(6)):(f=!1,r="clone-"+i);n("#"+r).spinner("value",e.spinner("value"));u=i.substring(0,6)=="clone-"?i.substring(6):i;t.oCharacters[u].stateSet=!1;t.oCharacters[u].userInput=null;t.refreshVisualisation()})};t.keyInput.getCharacterToolTip=function(i){var h=n("<div/>"),c=!1,o,r,s,v,k,f,w,e;t.oCharacters[i].HelpShort&&t.oCharacters[i].HelpShort!=""?(o=t.oCharacters[i].HelpShort,c=!0):o=t.oCharacters[i].Help;var b=t.media.filter(function(n){if((n.Type=="image-local"||n.Type=="image-web")&&n.Character==i)return!0}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)}),u,l=0,a=0;if(b.forEach(function(n){var t=!1,i=!1;n.UseFor?n.UseFor.split(",").forEach(function(r){r.toLowerCase().trim()=="tip"&&(i=n.State?!1:!0);r.toLowerCase().trim()=="full"&&(t=!0)}):(i=n.State?!1:!0,t=!0);i&&!u?u=n:t&&l++;t&&a++}),s=!1,u&&(r=n("<figure/>"),r.addClass("helpFigure"),v=n("<img/>",{src:u.URI}).appendTo(r).css("margin-top",2),u.ImageWidth&&v.css("width",u.ImageWidth),k=n("<figcaption/>",{html:u.Caption}).appendTo(r),u.TipStyle&&u.TipStyle!="")){var y=u.TipStyle.split("-"),p=y[0],d=y[1];r.css("width",d+"%");r.css("float",p);r.css("margin-bottom",5);p=="right"?r.css("margin-left",5):r.css("margin-right",5);s=!0}return f=[],s&&f.push(r),o.length>0&&f.push(n("<span/>").html(o)),!s&&r&&f.push(r),f.forEach(function(n){h.append(n)}),w=t.values.filter(function(n){if(n.Character==i&&n.StateHelp)return!0}),e="",c||l>0||w.length>0?e="(Click for <b>more detailed help<\/b>.)":u&&a>0&&(e="(Click for resizeable help window.)"),e&&n("<div/>").css("margin-top",5).css("font-weight","normal").html(e).appendTo(h),h};t.keyInput.showCharacterHelp=function(i){var r,u;n("#tombioKeyInputDialog").html("");n("<h3/>",{text:t.oCharacters[i].Label}).appendTo("#tombioKeyInputDialog");n("<p/>",{html:t.oCharacters[i].Help}).appendTo("#tombioKeyInputDialog");r=t.media.filter(function(n){if((n.Type=="image-local"||n.Type=="image-web")&&n.Character==i&&!n.State){if(n.UseFor){var t=!1;return n.UseFor.split(",").forEach(function(n){n.toLowerCase().trim()=="full"&&(t=!0)}),t}return!0}}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)});r.forEach(function(t,i){var f=n("<figure/>").appendTo("#tombioKeyInputDialog"),r,u;f.addClass("helpFigure");r=n("<img/>",{src:t.URI});u=n("<figcaption/>",{html:t.Caption});f.append(r).append(u);i>0&&r.css("margin-top",10);u.appendTo("#tombioKeyInputDialog");t.ImageWidth&&r.css("width",t.ImageWidth)});u=t.values.filter(function(n){if(n.Character==i&&n.StateHelp)return!0});u.forEach(function(r){var f,u,e,o,s;f=r.CharacterStateTranslation&&r.CharacterStateTranslation!=""?r.CharacterStateTranslation:r.CharacterState;u=n("<p/>").appendTo("#tombioKeyInputDialog");e=n("<span/>",{text:f+": "}).css("font-weight","Bold");u.append(e);o=n("<span/>",{html:r.StateHelp}).css("font-weight","Normal");u.append(o);s=t.media.filter(function(n){if((n.Type=="image-local"||n.Type=="image-web")&&n.Character==i&&n.State==r.CharacterState)return!0}).sort(function(n,t){return Number(n.Priority)-Number(t.Priority)});s.forEach(function(t,i){var r=n("<img/>",{src:t.URI}),u=n("<figcaption/>",{html:t.Caption});r.appendTo("#tombioKeyInputDialog");i>0&&r.css("margin-top",10);u.appendTo("#tombioKeyInputDialog");t.ImageWidth&&r.css("width",t.ImageWidth)})});n("#tombioKeyInputDialog").dialog("option","title","Character help and information");n("#tombioKeyInputDialog").dialog("open")}})(jQuery,this.tombiovis);